<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>6 Helper Classes</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    <h1><a name="6 Helper Classes">6 Helper Classes</a></h1>Use the plugin helper classes in your application to avoid dealing with some lower-level details of Spring Security.
<h2><a name="6.1 SecurityTagLib">6.1 SecurityTagLib</a></h2>The plugin includes GSP tags to support conditional display based on whether the user is authenticated, and/or has the required role to perform a particular action. These tags are in the <code>sec</code> namespace and are implemented in <code>grails.plugins.springsecurity.SecurityTagLib</code>.<p class="paragraph"/><h4>ifLoggedIn</h4>
Displays the inner body content if the user is authenticated.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Welcome Back!
&#60;/sec:ifLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifNotLoggedIn</h4>
Displays the inner body content if the user is not authenticated.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifNotLoggedIn&#62;
&#60;g:link controller='login' action='auth'&#62;Login&#60;/g:link&#62;
&#60;/sec:ifNotLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifAllGranted</h4>
Displays the inner body content only if all of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifAllGranted roles=<span class="java&#45;quote">"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&#62;secure stuff here&#60;/sec:ifAllGranted&#62;</pre></div><p class="paragraph"/><h4>ifAnyGranted</h4>
Displays the inner body content if at least one of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifAnyGranted roles=<span class="java&#45;quote">"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&#62;secure stuff here&#60;/sec:ifAnyGranted&#62;</pre></div><p class="paragraph"/><h4>ifNotGranted</h4>
Displays the inner body content if none of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifNotGranted roles=<span class="java&#45;quote">"ROLE_USER"</span>&#62;non&#45;user stuff here&#60;/sec:ifNotGranted&#62;</pre></div><p class="paragraph"/><h4> loggedInUserInfo</h4>
Displays the value of the specified authentication field if logged in. For example, to show the username property:<p class="paragraph"/><div class="code"><pre>&#60;sec:loggedInUserInfo field=<span class="java&#45;quote">"username"</span>/&#62;</pre></div><p class="paragraph"/>If you have customized the authentication to add a <code>fullName</code> property, you access it as follows:<p class="paragraph"/><div class="code"><pre>Welcome Back &#60;sec:loggedInUserInfo field=<span class="java&#45;quote">"fullName"</span>/&#62;</pre></div><p class="paragraph"/><h4> username</h4>
Displays the value of the authentication <code>username</code> field if logged in.<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Welcome Back &#60;sec:username/&#62;!
&#60;/sec:ifLoggedIn&#62;
&#60;sec:ifNotLoggedIn&#62;
&#60;g:link controller='login' action='auth'&#62;Login&#60;/g:link&#62;
&#60;/sec:ifNotLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifSwitched</h4>
Displays the inner body content only if the current user switched from another user. (See also <a href="../guide/single.html#15 Switch User" class="guide">Switch User</a>.)<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Logged in as &#60;sec:username/&#62;
&#60;/sec:ifLoggedIn&#62;<p class="paragraph"/>&#60;sec:ifSwitched&#62;
&#60;a href='$&#123;request.contextPath&#125;/j_spring_security_exit_user'&#62;
   Resume as &#60;sec:switchedUserOriginalUsername/&#62;
&#60;/a&#62;
&#60;/sec:ifSwitched&#62;<p class="paragraph"/>&#60;sec:ifNotSwitched&#62;<p class="paragraph"/>   &#60;sec:ifAllGranted roles='ROLE_SWITCH_USER'&#62;<p class="paragraph"/>   &#60;form action='$&#123;request.contextPath&#125;/j_spring_security_switch_user' method='POST'&#62;<p class="paragraph"/>      Switch to user: &#60;input type='text' name='j_username'/&#62;&#60;br/&#62;<p class="paragraph"/>      &#60;input type='submit' value='Switch'/&#62; &#60;/form&#62;<p class="paragraph"/>   &#60;/sec:ifAllGranted&#62;<p class="paragraph"/>&#60;/sec:ifNotSwitched&#62;</pre></div><p class="paragraph"/><h4>ifNotSwitched</h4>
Displays the inner body content only if the current user has not switched from another user.<p class="paragraph"/><h4>switchedUserOriginalUsername</h4>
Renders the original user's username if the current user switched from another user.<p class="paragraph"/><div class="code"><pre>&#60;sec:ifSwitched&#62;
&#60;a href='$&#123;request.contextPath&#125;/j_spring_security_exit_user'&#62;
   Resume as &#60;sec:switchedUserOriginalUsername/&#62;
&#60;/a&#62;
&#60;/sec:ifSwitched&#62;</pre></div><p class="paragraph"/><h4>access</h4><p class="paragraph"/>Renders the body if the specified expression evaluates to <code>true</code> or specified URL is allowed.<p class="paragraph"/><div class="code"><pre>&#60;sec:access expression=<span class="java&#45;quote">"hasRole('ROLE_USER')"</span>&#62;<p class="paragraph"/>You're a user<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/><div class="code"><pre>&#60;sec:access url=<span class="java&#45;quote">"/admin/user"</span>&#62;<p class="paragraph"/>&#60;g:link controller='admin' action='user'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>You can also guard access to links generated from controller and action names or named URL mappings instead of hard-coding the values, for example<p class="paragraph"/><div class="code"><pre>&#60;sec:access controller='admin' action='user'&#62;<p class="paragraph"/>&#60;g:link controller='admin' action='user'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>or if you have a named URL mapping you can refer to that:<p class="paragraph"/><div class="code"><pre>&#60;sec:access mapping='manageUsers'&#62;<p class="paragraph"/>&#60;g:link mapping='manageUsers'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>For even more control of the generated URL (still avoiding hard-coding) you can use <code>createLink</code> to build the URL, for example<p class="paragraph"/><div class="code"><pre>&#60;sec:access url='$&#123;createLink(controller: 'admin', action: 'user', base: <span class="java&#45;quote">"/"</span>)&#125;'&#62;<p class="paragraph"/>&#60;g:link controller='admin' action='user'&#62;Manage Users&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:access&#62;</pre></div><p class="paragraph"/>Be sure to include the <code>base: "/"</code> attribute in this case to avoid appending the context name to the URL.<p class="paragraph"/><h4>noAccess</h4><p class="paragraph"/>Renders the body if the specified expression evaluates to <code>false</code> or URL isn't allowed.<p class="paragraph"/><div class="code"><pre>&#60;sec:noAccess expression=<span class="java&#45;quote">"hasRole('ROLE_USER')"</span>&#62;<p class="paragraph"/>You're not a user<p class="paragraph"/>&#60;/sec:noAccess&#62;</pre></div>
<h2><a name="6.2 SpringSecurityService">6.2 SpringSecurityService</a></h2><code>grails.plugins.springsecurity.SpringSecurityService</code> provides security utility functions. It is a regular Grails service, so you use dependency injection to inject it into a controller, service, taglib, and so on:<p class="paragraph"/><div class="code"><pre>def springSecurityService</pre></div><p class="paragraph"/><h4>getCurrentUser()</h4>
Retrieves a domain class instance for the currently authenticated user. During authentication a user/person domain class instance is loaded to get the user's password, roles, etc. and the id of the instance is saved. This method uses the id and the domain class to re-load the instance.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def user = springSecurityService.currentUser
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>isLoggedIn()</h4>
Checks whether there is a currently logged-in user.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      <span class="java&#45;keyword">if</span> (springSecurityService.isLoggedIn()) &#123;
         &#8230;
      &#125;
      <span class="java&#45;keyword">else</span> &#123;
         &#8230;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getAuthentication()</h4><p class="paragraph"/>Retrieves the current user's <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html" target="blank">Authentication</a>. If authenticated in, this will typically be a <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/UsernamePasswordAuthenticationToken.html" target="blank">UsernamePasswordAuthenticationToken</a>.<p class="paragraph"/>If not authenticated and the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/authentication/AnonymousAuthenticationFilter.html" target="blank">AnonymousAuthenticationFilter</a> is active (true by default) then the anonymous user's authentication will be returned (<a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AnonymousAuthenticationToken.html" target="blank">AnonymousAuthenticationToken</a> with username 'anonymousUser' unless overridden).<p class="paragraph"/>
Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def auth = springSecurityService.authentication
      <span class="java&#45;object">String</span> username = auth.username
      def authorities = auth.authorities // a Collection of GrantedAuthority
      <span class="java&#45;object">boolean</span> authenticated = auth.authenticated
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getPrincipal()</h4><p class="paragraph"/>Retrieves the currently logged in user's <code>Principal</code>. If authenticated, the principal will be a <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code>, unless you  have created a custom <code>UserDetailsService</code>, in which case it will be whatever implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetails.html" target="blank">UserDetails</a> you use there.<p class="paragraph"/>If not authenticated and the <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/web/authentication/AnonymousAuthenticationFilter.html" target="blank">AnonymousAuthenticationFilter</a> is active (true by default) then the anonymous user's name will be returned ('anonymousUser' unless overridden).<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def principal = springSecurityService.principal
      <span class="java&#45;object">String</span> username = principal.username
      def authorities = principal.authorities // a Collection of GrantedAuthority
      <span class="java&#45;object">boolean</span> enabled = principal.enabled
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>encodePassword()</h4>
Encrypts a password with the configured encryption scheme. By default the plugin uses SHA-256, but you can configure the scheme with the <code>grails.plugins.springsecurity.password.algorithm</code> attribute in <code>Config.groovy</code>. You can use any message digest algorithm that is supported in your JDK; see <a href="http://java.sun.com/j2se/1.5.0/docs/guide/security/CryptoSpec.html#AppA" target="blank">this Java page</a>.
<blockquote class="warning">
You are <strong class="bold">strongly</strong> discouraged from using MD5 or SHA-1 algorithms because of their well-known vulnerabilities. You should also use a salt for your passwords, which greatly increases the computational complexity of decrypting passwords if your database gets compromised. See <a href="../guide/single.html#12.2 Salted Passwords" class="guide">Salted Passwords</a>.
</blockquote><p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class PersonController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def updateAction = &#123;
      def person = Person.get(params.id)<p class="paragraph"/>      params.salt = person.salt
      <span class="java&#45;keyword">if</span> (person.password != params.password) &#123;
         params.password = springSecurityService.encodePassword(password, salt)
         def salt = &#8230; // e.g. randomly generated using some utility method
         params.salt = salt
      &#125;
      person.properties = params
      <span class="java&#45;keyword">if</span> (!person.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;person: person&#93;
         <span class="java&#45;keyword">return</span>
      &#125;
      redirect action: show, id: person.id
   &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
If you are encoding the password in the User domain class (using <code>beforeInsert</code> and <code>encodePassword</code>) then don't call <code>springSecurityService.encodePassword()</code> in your controller since you'll double-encrypt the password and users won't be able to log in. It's best to encapsulate the password handling logic in the domain class.
</blockquote><p class="paragraph"/><h4>updateRole()</h4>
Updates a role and, if you use <code>Requestmap</code> instances to secure URLs, updates the role name in all affected <code>Requestmap</code> definitions if the name was changed.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RoleController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def update = &#123;
      def roleInstance = Role.get(params.id)
      <span class="java&#45;keyword">if</span> (!springSecurityService.updateRole(roleInstance, params)) &#123;
         render view: 'edit', model: &#91;roleInstance: roleInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The role was updated"</span>
      redirect action: show, id: roleInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>deleteRole()</h4>
Deletes a role and, if you use <code>Requestmap</code> instances to secure URLs, removes the role from all affected <code>Requestmap</code> definitions. If a <code>Requestmap</code>'s config attribute is only the role name (for example, "/foo/bar/&#42;&#42;=ROLE_FOO"), it is deleted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RoleController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def delete = &#123;
      def roleInstance = Role.get(params.id)
      <span class="java&#45;keyword">try</span> &#123;
         springSecurityService.deleteRole (roleInstance
         flash.message = <span class="java&#45;quote">"The role was deleted"</span>
         redirect action: list
      &#125;
      <span class="java&#45;keyword">catch</span> (DataIntegrityViolationException e) &#123;
         flash.message = <span class="java&#45;quote">"Unable to delete the role"</span>
         redirect action: show, id: params.id
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>clearCachedRequestmaps()</h4>
Flushes the Requestmaps cache and triggers a complete reload. If you use <code>Requestmap</code> instances to secure URLs, the plugin loads and caches all <code>Requestmap</code> instances as a performance optimization. This action saves database activity because the requestmaps are checked for each request. Do not allow the cache to become stale. When you create, edit or delete a <code>Requestmap</code>, flush the cache. Both <code>updateRole()</code> and <code>deleteRole()</code> call clearCachedRequestmaps()for you. Call this method when you create a new <code>Requestmap</code> or do other <code>Requestmap</code> work that affects the cache.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RequestmapController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def save = &#123;
      def requestmapInstance = <span class="java&#45;keyword">new</span> Requestmap(params)
      <span class="java&#45;keyword">if</span> (!requestmapInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'create', model: &#91;requestmapInstance: requestmapInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      springSecurityService.clearCachedRequestmaps()
      flash.message = <span class="java&#45;quote">"Requestmap created"</span>
      redirect action: show, id: requestmapInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>reauthenticate()</h4>
Rebuilds an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html" target="blank">Authentication</a> for the given username and registers it in the security context. You typically use this method after updating a user's authorities or other data that is cached in the <code>Authentication</code> or <code>Principal</code>. It also removes the user from the user cache to force a refresh at next login.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class UserController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def update = &#123;
      def userInstance = User.get(params.id)<p class="paragraph"/>      params.salt = person.salt
      <span class="java&#45;keyword">if</span> (params.password) &#123;
         params.password = springSecurityService.encodePassword(params.password, salt)
         def salt = &#8230; // e.g. randomly generated using some utility method
         params.salt = salt
      &#125;
      userInstance.properties = params
      <span class="java&#45;keyword">if</span> (!userInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;userInstance: userInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (springSecurityService.loggedIn &#38;&#38;
             springSecurityService.principal.username == userInstance.username) &#123;
         springSecurityService.reauthenticate userInstance.username
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The user was updated"</span>
      redirect action: show, id: userInstance.id
   &#125;
&#125;</pre></div>
<h2><a name="6.3 SpringSecurityUtils">6.3 SpringSecurityUtils</a></h2><code>org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils</code> is a utility class with static methods that you can call directly without using dependency injection. It is primarily an internal class but can be called from application code.<p class="paragraph"/><h4>authoritiesToRoles()</h4>
Extracts role names from an array or <code>Collection</code> of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html" target="blank">GrantedAuthority</a>.<p class="paragraph"/><h4>getPrincipalAuthorities()</h4>
Retrieves the currently logged-in user's authorities. It is empty (but never <code>null</code>) if the user is not logged in.<p class="paragraph"/><h4>parseAuthoritiesString()</h4>
Splits a comma-delimited String containing role names into a <code>List</code> of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html" target="blank">GrantedAuthority</a>.<p class="paragraph"/><h4>ifAllGranted()</h4>
Checks whether the current user has all specified roles (a comma-delimited String of role names). Primarily used by <code>SecurityTagLib.ifAllGranted</code>.<p class="paragraph"/><h4>ifNotGranted()</h4>
Checks whether the current user has none of the specified roles (a comma-delimited String of role names). Primarily used by <code>SecurityTagLib.ifNotGranted</code>.<p class="paragraph"/><h4>ifAnyGranted()</h4>
Checks whether the current user has any of the specified roles (a comma-delimited String of role names). Primarily used by <code>SecurityTagLib.ifAnyGranted</code>.<p class="paragraph"/><h4>getSecurityConfig()</h4>
Retrieves the security part of the <code>Configuration</code> (from <code>grails-app/conf/Config.groovy</code>).<p class="paragraph"/><h4>loadSecondaryConfig()</h4>
Used by dependent plugins to add configuration attributes.<p class="paragraph"/><h4>reloadSecurityConfig()</h4>
Forces a reload of the security configuration.<p class="paragraph"/><h4>isAjax()</h4>
Checks whether the request was triggered by an Ajax call. The standard way is to determine whether <code>X-Requested-With</code> request header is set and has the value <code>XMLHttpRequest</code>. The plugin only checks whether the header is set to any value. In addition, you can configure the name of the header with the <code>grails.plugins.springsecurity.ajaxHeader</code> configuration attribute, but this is not recommended because all major JavaScript toolkits use the standard name.<p class="paragraph"/>You can also force the request to be treated as Ajax by appending <code>&#38;ajax=true</code> to your request query string.<p class="paragraph"/><h4>registerProvider()</h4>
Used by dependent plugins to register an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AuthenticationProvider.html" target="blank">AuthenticationProvider</a> bean name.<p class="paragraph"/><h4>registerFilter()</h4>
Used by dependent plugins to register a filter bean name in a specified position in the filter chain.<p class="paragraph"/><h4>isSwitched()</h4>
Checks whether the current user switched from another user.<p class="paragraph"/><h4>getSwitchedUserOriginalUsername()</h4>
Gets the original user's username if the current user switched from another user.<p class="paragraph"/><h4>doWithAuth()</h4><p class="paragraph"/>Executes a Closure with the current authentication. The one-parameter version which takes just a Closure assumes that there's an authentication in the HTTP Session and that the Closure is running in a separate thread from the web request, so the <code>SecurityContext</code> and <code>Authentication</code> aren't available to the standard <code>ThreadLocal</code>. This is primarily of use when you explicitly launch a new thread from a controller action or service called in request scope, not from a Quartz job which isn't associated with an authentication in any thread.<p class="paragraph"/>The two-parameter version takes a Closure and a username to authenticate as. This is will authenticate as the specified user and execute the closure with that authentication. It restores the authentication to the one that was active if it exists, or clears the context otherwise. This is similar to run-as and switch-user but is only local to the Closure.

    
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
