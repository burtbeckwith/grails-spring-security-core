<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>7. Custom UserDetailsService</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    Hopefully the default configuraton plus the configurability exposed in <code>DefaultSecurityConfig.groovy</code> and <code>grails-app/conf/Config.groovy</code> enable most customization needs for your applications. However security is a large topic and there are many possible ways to secure an application.<p class="paragraph"/>When authenticating users from a database using <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/dao/DaoAuthenticationProvider.html" target="blank">DaoAuthenticationProvider</a> (the default mode in the plugin if you haven't enabled OpenID, LDAP, etc.), an implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetailsService.html" target="blank">UserDetailsService</a> is required. This class is responsible for returning a concrete implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetails.html" target="blank">UserDetails</a>. The plugin provides <code>org.codehaus.groovy.grails.plugins.springsecurity.GormUserDetailsService</code> as its <code>UserDetailsService</code> implementation and <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code> (which extends Spring Security's <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/User.html" target="blank">User</a>) as its <code>UserDetails</code> implementation.<p class="paragraph"/>You can extend or replace <code>GormUserDetailsService</code> with your own implementation by defining a bean in <code>grails-app/conf/spring/resources.groovy</code> (or <code>resources.xml</code>) with the same bean name, <code>userDetailsService</code>. This works because application beans are configured after plugin beans and there can only be one bean for each name.<p class="paragraph"/>Here's an example <code>UserDetails</code> and <code>UserDetailsService</code> implementation that adds the full name of the user domain class in addition to the standard information. If you extract extra data from your domain class, you'll be less likely to need to reload the user from the database - most of your common data can be kept along with your security credentials.<p class="paragraph"/>In this example we're adding in a <code>fullName</code> field. Keeping the full name cached avoids hitting the database just for that lookup. <code>GrailsUser</code> already adds the <code>id</code> value from the domain class to so we can do a more efficient database load of the user. If all you have is the username, then you need to call <code>User.findByUsername(principal.username)</code>, but if you have the id you can call <code>User.get(principal.id)</code>. Even if you have a unique index on the <code>username</code> database column, loading by primary key will usually be more efficient since it can take advantage of Hibernate's first-level and second-level caches.<p class="paragraph"/>There's really not much to implement other than your application-specific lookup code:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.foo.bar<p class="paragraph"/><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.security.core.GrantedAuthority
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.User<p class="paragraph"/>class MyUserDetails <span class="java&#45;keyword">extends</span> GrailsUser &#123;<p class="paragraph"/>   <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> fullName<p class="paragraph"/>   MyUserDetails(<span class="java&#45;object">String</span> username, <span class="java&#45;object">String</span> password, <span class="java&#45;object">boolean</span> enabled,
                 <span class="java&#45;object">boolean</span> accountNonExpired, <span class="java&#45;object">boolean</span> credentialsNonExpired,
                 <span class="java&#45;object">boolean</span> accountNonLocked,
                 Collection&#60;GrantedAuthority&#62; authorities,
                 <span class="java&#45;object">long</span> id, <span class="java&#45;object">String</span> fullName) &#123;
      <span class="java&#45;keyword">super</span>(username, password, enabled, accountNonExpired,
            credentialsNonExpired, accountNonLocked, authorities, id)<p class="paragraph"/>      <span class="java&#45;keyword">this</span>.fullName = fullName
   &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.foo.bar<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.UserDetails
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService<p class="paragraph"/>class MyUserDetailsService <span class="java&#45;keyword">implements</span> UserDetailsService &#123;<p class="paragraph"/>   UserDetails loadUserByUsername(<span class="java&#45;object">String</span> username) <span class="java&#45;keyword">throws</span> UsernameNotFoundException &#123;
      // lookup user and data
      <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> MyUserDetails(username, password, enabled,
                               accountNonExpired, credentialsNonExpired,
                               accountNonLocked, authorities, id, fullName)
   &#125;
&#125;</pre></div><p class="paragraph"/>and to use it, register it in <code>grails-app/conf/spring/resources.groovy</code> like this:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   userDetailsService(com.foo.bar.MyUserDetailsService)
&#125;</pre></div><p class="paragraph"/>Another option if you want to load users and roles from the database is to subclass <code>org.codehaus.groovy.grails.plugins.springsecurity.GormUserDetailsService</code> - the methods are all protected so you can override whatever you want.<p class="paragraph"/>Also note that this approach works with all beans defined in <code>SpringSecurityCoreGrailsPlugin.doWithSpring()</code> - you can replace or subclass any of the Spring beans to provide your own functionality when the standard extension mechanisms aren't sufficient.<p class="paragraph"/><h4>Flushing the cached <code>Authentication</code></h4><p class="paragraph"/>If you store mutable data in your custom <code>UserDetails</code> implementation (for example full name like in this example), be sure to rebuild the <code>Authentication</code> if it changes. <code>springSecurityService</code> has a <code>reauthenticate</code> method that will do this for you:<p class="paragraph"/><div class="code"><pre>class MyController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction &#123;
      def user = &#8230;
      // update user data
      user.save()
      springSecurityService.reauthenticate user.username
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>
    </body>
</html>
