<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>1.2 Migration from the Acegi plugin</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    This plugin is a successor to the original plugin that provided support for Spring Security, the <a href="http://grails.org/plugin/acegi/" target="blank">Acegi plugin</a>. It's a new plugin that doesn't depend on that plugin but there are many similarities, so migrating is fairly straightforward.<p class="paragraph"/><h4>Core differences</h4><p class="paragraph"/>The Spring Security plugin retains many of the core features of the Acegi plugin:
<ul class="star">
<li>form-based authentication</li>
<li>storing users, roles, and optionally requestmaps in the database and accessing via domain classes</li>
<li>guarding URLs with annotations, requestmap domain class, or static configuration</li>
<li>security tags</li>
<li>security service</li>
<li>security events</li>
<li>Ajax login</li>
<li>Basic auth</li>
<li>Switch User</li>
<li>Channel security</li>
<li>IP Address Restrictions</li>
</ul><p class="paragraph"/>and in addition adds several new features:
<ul class="star">
<li>Digest Auth</li>
<li>Session Fixation</li>
<li>Salted passwords</li>
<li>Certificate (x509) login</li>
<li>Hierarchical Roles</li>
<li>Account Locking and Forcing Password Change</li>
</ul><p class="paragraph"/>There are a few core concepts that have changed and will require configuration changes in your application:
<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th>&#160;</th><th><strong class="bold">Spring Security plugin</strong></th><th><strong class="bold">Acegi plugin</strong></th></tr><tr class="table-odd"><td>enabled by default</td><td><code>true</code></td><td><code>false</code></td></tr><tr class="table-even"><td>cache UserDetails by default</td><td><code>false</code></td><td><code>true</code></td></tr><tr class="table-odd"><td>configuration location</td><td><code>grails-app/conf/Config.groovy</code></td><td><code>grails-app/conf/SecurityConfig.groovy</code></td></tr><tr class="table-even"><td>security service</td><td><code>springSecurityService</code></td><td><code>authenticateService</code></td></tr></table><p class="paragraph"/>There are features that are not included but which will be available in secondary plugins that will extend and depend on the core plugin:
<ul class="star">
<li>Facebook</li>
<li>OpenID</li>
<li>LDAP</li>
<li>CAS</li>
<li>NTLM</li>
<li>Kerberos</li>
<li>User registration</li>
</ul><p class="paragraph"/><h4>Configuration differences</h4><p class="paragraph"/>This table summarizes the configuration attribute names in both plugins:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Acegi plugin</strong></th><th><strong class="bold">Spring Security plugin</strong></th></tr><tr class="table-odd"><td>active</td><td>active</td></tr><tr class="table-even"><td>loginUserDomainClass</td><td>userLookup.userDomainClassName</td></tr><tr class="table-odd"><td>userName</td><td>userLookup.usernamePropertyName</td></tr><tr class="table-even"><td>enabled</td><td>userLookup.enabledPropertyName</td></tr><tr class="table-odd"><td>password</td><td>userLookup.passwordPropertyName</td></tr><tr class="table-even"><td>relationalAuthorities</td><td>userLookup.authoritiesPropertyName</td></tr><tr class="table-odd"><td>getAuthoritiesMethod</td><td>N/A</td></tr><tr class="table-even"><td>authorityDomainClass</td><td>authority.className</td></tr><tr class="table-odd"><td>authorityField</td><td>authority.nameField</td></tr><tr class="table-even"><td>authenticationFailureUrl</td><td>failureHandler.defaultFailureUrl</td></tr><tr class="table-odd"><td>ajaxAuthenticationFailureUrl</td><td>failureHandler.ajaxAuthFailUrl</td></tr><tr class="table-even"><td>defaultTargetUrl</td><td>successHandler.defaultTargetUrl</td></tr><tr class="table-odd"><td>alwaysUseDefaultTargetUrl</td><td>successHandler.alwaysUseDefault</td></tr><tr class="table-even"><td>filterProcessesUrl</td><td>apf.filterProcessesUrl</td></tr><tr class="table-odd"><td>key</td><td>anon.key</td></tr><tr class="table-even"><td>userAttribute</td><td>anon.userAttribute</td></tr><tr class="table-odd"><td>loginFormUrl</td><td>auth.loginFormUrl</td></tr><tr class="table-even"><td>forceHttps</td><td>auth.forceHttps</td></tr><tr class="table-odd"><td>ajaxLoginFormUrl</td><td>auth.ajaxLoginFormUrl</td></tr><tr class="table-even"><td>afterLogoutUrl</td><td>logout.afterLogoutUrl</td></tr><tr class="table-odd"><td>errorPage</td><td>adh.errorPage</td></tr><tr class="table-even"><td>ajaxErrorPage</td><td>adh.ajaxErrorPage</td></tr><tr class="table-odd"><td>ajaxHeader</td><td>ajaxHeader</td></tr><tr class="table-even"><td>algorithm</td><td>password.algorithm</td></tr><tr class="table-odd"><td>encodeHashAsBase64</td><td>password.encodeHashAsBase64</td></tr><tr class="table-even"><td>cookieName</td><td>rememberMe.cookieName</td></tr><tr class="table-odd"><td>alwaysRemember</td><td>rememberMe.alwaysRemember</td></tr><tr class="table-even"><td>tokenValiditySeconds</td><td>rememberMe.tokenValiditySeconds</td></tr><tr class="table-odd"><td>parameter</td><td>rememberMe.parameter</td></tr><tr class="table-even"><td>rememberMeKey</td><td>rememberMe.key</td></tr><tr class="table-odd"><td>useLogger</td><td>registerLoggerListener</td></tr><tr class="table-even"><td>useRequestMapDomainClass</td><td>securityConfigType = <code>SecurityConfigType.Requestmap</code></td></tr><tr class="table-odd"><td>requestMapClass</td><td>requestMap.className</td></tr><tr class="table-even"><td>requestMapPathField</td><td>requestMap.urlField</td></tr><tr class="table-odd"><td>requestMapConfigAttributeField</td><td>requestMap.configAttributeField</td></tr><tr class="table-even"><td>useControllerAnnotations</td><td>securityConfigType = <code>SecurityConfigType.Annotation</code></td></tr><tr class="table-odd"><td>controllerAnnotationsMatcher</td><td>controllerAnnotations.matcher</td></tr><tr class="table-even"><td>controllerAnnotationsMatchesLowercase</td><td>controllerAnnotations.lowercase</td></tr><tr class="table-odd"><td>controllerAnnotationStaticRules</td><td>controllerAnnotations.staticRules</td></tr><tr class="table-even"><td>controllerAnnotationsRejectIfNoRule</td><td>rejectIfNoRule</td></tr><tr class="table-odd"><td>requestMapString</td><td>N/A - securityConfigType = <code>SecurityConfigType.InterceptUrlMap</code> is very similar</td></tr><tr class="table-even"><td>realmName</td><td>basic.realmName</td></tr><tr class="table-odd"><td>basicProcessingFilter</td><td>useBasicAuth</td></tr><tr class="table-even"><td>switchUserProcessingFilter</td><td>useSwitchUserFilter</td></tr><tr class="table-odd"><td>swswitchUserUrl</td><td>switchUser.switchUserUrl</td></tr><tr class="table-even"><td>swexitUserUrl</td><td>switchUser.exitUserUrl</td></tr><tr class="table-odd"><td>swtargetUrl</td><td>switchUser.targetUrl</td></tr><tr class="table-even"><td>useMail</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-odd"><td>mailHost</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-even"><td>mailUsername</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-odd"><td>mailPassword</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-even"><td>mailProtocol</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-odd"><td>mailFrom</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-even"><td>mailPort</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-odd"><td>defaultRole</td><td>N/A - registration will be supported in the UI plugin</td></tr><tr class="table-even"><td>useOpenId</td><td>N/A - will be supported in the OpenID plugin</td></tr><tr class="table-odd"><td>openIdNonceMaxSeconds</td><td>N/A - will be supported in the OpenID plugin</td></tr><tr class="table-even"><td>useLdap</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-odd"><td>ldapRetrieveGroupRoles</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-even"><td>ldapRetrieveDatabaseRoles</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-odd"><td>ldapSearchSubtree</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-even"><td>ldapGroupRoleAttribute</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-odd"><td>ldapPasswordAttributeName</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-even"><td>ldapServer</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-odd"><td>ldapManagerDn</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-even"><td>ldapManagerPassword</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-odd"><td>ldapSearchBase</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-even"><td>ldapSearchFilter</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-odd"><td>ldapGroupSearchBase</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-even"><td>ldapGroupSearchFilter</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-odd"><td>ldapUsePassword</td><td>N/A - will be supported in the LDAP plugin</td></tr><tr class="table-even"><td>useKerberos</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>kerberosLoginConfigFile</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>kerberosRealm</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>kerberosKdc</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>kerberosRetrieveDatabaseRoles</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>useHttpSessionEventPublisher</td><td>useHttpSessionEventPublisher</td></tr><tr class="table-even"><td>cacheUsers</td><td>cacheUsers</td></tr><tr class="table-odd"><td>useCAS</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-even"><td>cas.casServer</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-odd"><td>cas.casServerPort</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-even"><td>cas.casServerSecure</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-odd"><td>cas.localhostSecure</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-even"><td>cas.failureURL</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-odd"><td>cas.defaultTargetURL</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-even"><td>cas.fullLoginURL</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-odd"><td>cas.fullServiceURL</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-even"><td>cas.authenticationProviderKey</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-odd"><td>cas.userDetailsService</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-even"><td>cas.sendRenew</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-odd"><td>cas.proxyReceptorUrl</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-even"><td>cas.filterProcessesUrl</td><td>N/A - will be supported in the CAS plugin</td></tr><tr class="table-odd"><td>useNtlm</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>ntlm.stripDomain</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>ntlm.retryOnAuthFailure</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>ntlm.forceIdentification</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>ntlm.defaultDomain</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-even"><td>ntlm.netbiosWINS</td><td>N/A - will be supported in a secondary plugin</td></tr><tr class="table-odd"><td>httpPort</td><td>portMapper.httpPort</td></tr><tr class="table-even"><td>httpsPort</td><td>portMapper.httpsPort</td></tr><tr class="table-odd"><td>secureChannelDefinitionSource</td><td>N/A, use secureChannel.definition</td></tr><tr class="table-even"><td>channelConfig</td><td>secureChannel.definition</td></tr><tr class="table-odd"><td>ipRestrictions</td><td>ipRestrictions</td></tr><tr class="table-even"><td>useFacebook</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-odd"><td>facebook.filterProcessesUrl</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-even"><td>facebook.authenticationUrlRoot</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-odd"><td>facebook.apiKey</td><td>N/A - will be supported in the Facebook plugin</td></tr><tr class="table-even"><td>facebook.secretKey</td><td>N/A - will be supported in the Facebook plugin</td></tr></table><p class="paragraph"/><h4>Script differences</h4><p class="paragraph"/>In the Acegi plugin you run the <code>create-auth-domains</code> script to initialize the plugin. This creates <code>grails-app/conf/SecurityConfig.groovy</code> to allow configuration customization, and creates the User, Role, and Requestmap domain classes, along with the Login and Logout controllers and views. In addition there's the <code>generate-manager</code> script which creates CRUD pages for the domain classes (earlier version of Grails didn't scaffold many-to-many relationships well, so these GSPs were necessary), and a <code>generate-registration</code> script which installs a basic user registration controller.<p class="paragraph"/>In the Spring Security plugin, there's just one script, <a href="../ref/Scripts/s2-quickstart.html" class="Scripts">s2-quickstart</a>. It's most similar to <code>create-auth-domains</code> since it creates domain classes and login/logout controllers, but it appends to <code>grails-app/conf/Config.groovy</code> instead of creating a standalone configuration file. There's no equivalent to <code>generate-manager</code> or <code>generate-registration</code> since there will be an optional UI plugin that will generate domain class management screens, an admin console, and forgot password and registration workflows. If you want to create your own CRUD pages you can use the standard Grails <code>generate-all</code> script. Various sections of this documentation discusses the changes you'll need to make in the generated source files, e.g. encrypting passwords before saving or updating a user.<p class="paragraph"/><h4>domainClass</h4><p class="paragraph"/>The Acegi plugin extended the <code>UserDetails</code> instance and added an accessor for the person domain class instance that was used to populate the <code>UserDetails</code>. This is convenient because since the <code>Authentication</code> is kept in the HTTP session and the <code>UserDetails</code> is attached to that, so it was easy to access non-security data such as full name, email, etc. without hitting the database.<p class="paragraph"/>This caused problems however. One is that if the domain class has a lot of data, you increase the size of the session payload and this is even worse if you have clustered sessions. Further, any lazy-loaded collections would fail to load after retrieving the person from the session since it would have become a detached Hibernate object. This caused confusion but is easily fixed, either by calling person.attach() or by reloading by id, i.e.<p class="paragraph"/><div class="code"><pre>def userDetails = authenticateService.principal()
def person = userDetails.domainClass
person = Person.get(person.id)</pre></div><p class="paragraph"/>but then the person has essentially become a very large wrapper around its primary key since that's the real data you're storing.<p class="paragraph"/>So the approach that this plugin takes is to not store the domain class but instead store the id so you can retrieve the person easily:<p class="paragraph"/><div class="code"><pre>def userDetails = springSecurityService.principal
person = Person.get(userDetails.id)</pre></div><p class="paragraph"/>This works because the <code>UserDetails</code> implementation is an instance of <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code> which extends the standard Spring Security <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/User.html" target="blank">User</a> and adds a <code>getId()</code> method.<p class="paragraph"/>You're encouraged to further extend this class if you want to store more data along with the authentication to avoid database access - see <a href="../guide/single.html#7. Custom UserDetailsService" class="guide">Chapter 7</a> for details on this.<p class="paragraph"/>
    
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker('UA-16219500-1');
pageTracker._trackPageview();
} catch(err) {}
</script>
</body>
</html>
