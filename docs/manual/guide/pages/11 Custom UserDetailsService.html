<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>11 Custom UserDetailsService</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    When you authenticate users from a database using <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/dao/DaoAuthenticationProvider.html" target="blank">DaoAuthenticationProvider</a> (the default mode in the plugin if you have not enabled OpenID, LDAP, and so on), an implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetailsService.html" target="blank">UserDetailsService</a> is required. This class is responsible for returning a concrete implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetails.html" target="blank">UserDetails</a>. The plugin provides <code>org.codehaus.groovy.grails.plugins.springsecurity.GormUserDetailsService</code> as its <code>UserDetailsService</code> implementation and <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code> (which extends Spring Security's <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/User.html" target="blank">User</a>) as its <code>UserDetails</code> implementation.<p class="paragraph"/>You can extend or replace <code>GormUserDetailsService</code> with your own implementation by defining a bean in <code>grails-app/conf/spring/resources.groovy</code> (or <code>resources.xml</code>) with the same bean name, <code>userDetailsService</code>. This works because application beans are configured after plugin beans and there can only be one bean for each name. The plugin uses an extension of <code>UserDetailsService</code>, <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUserDetailsService</code>, which adds the method <code>UserDetails loadUserByUsername(String username, boolean loadRoles)</code> to support use cases like in LDAP where you often infer all roles from LDAP but might keep application-specific user details in the database.<p class="paragraph"/>In the following example, the <code>UserDetails</code> and <code>GrailsUserDetailsService</code> implementation adds the full name of the user domain class in addition to the standard information. If you extract extra data from your domain class, you are less likely to need to reload the user from the database. Most of your common data can be kept along with your security credentials.<p class="paragraph"/>This example adds in a <code>fullName</code> field. Keeping the full name cached avoids hitting the database just for that lookup. <code>GrailsUser</code> already adds the <code>id</code> value from the domain class to so we can do a more efficient database load of the user. If all you have is the username, then you need to call <code>User.findByUsername(principal.username)</code>, but if you have the id you can call <code>User.get(principal.id)</code>. Even if you have a unique index on the <code>username</code> database column, loading by primary key is usually more efficient because it takes advantage of Hibernate's first-level and second-level caches.<p class="paragraph"/>There is not much to implement other than your application-specific lookup code:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.security.core.GrantedAuthority
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.User<p class="paragraph"/>class MyUserDetails <span class="java&#45;keyword">extends</span> GrailsUser &#123;<p class="paragraph"/>   <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> fullName<p class="paragraph"/>   MyUserDetails(<span class="java&#45;object">String</span> username, <span class="java&#45;object">String</span> password, <span class="java&#45;object">boolean</span> enabled,
                 <span class="java&#45;object">boolean</span> accountNonExpired, <span class="java&#45;object">boolean</span> credentialsNonExpired,
                 <span class="java&#45;object">boolean</span> accountNonLocked,
                 Collection&#60;GrantedAuthority&#62; authorities,
                 <span class="java&#45;object">long</span> id, <span class="java&#45;object">String</span> fullName) &#123;
      <span class="java&#45;keyword">super</span>(username, password, enabled, accountNonExpired,
            credentialsNonExpired, accountNonLocked, authorities, id)<p class="paragraph"/>      <span class="java&#45;keyword">this</span>.fullName = fullName
   &#125;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUserDetailsService
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils
<span class="java&#45;keyword">import</span> org.springframework.security.core.authority.GrantedAuthorityImpl
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.UserDetails
<span class="java&#45;keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException<p class="paragraph"/>class MyUserDetailsService <span class="java&#45;keyword">implements</span> GrailsUserDetailsService &#123;<p class="paragraph"/>   /&#42;&#42;
    &#42; Some Spring Security classes (e.g. RoleHierarchyVoter) expect at least one role, so
    &#42; we give a user with no granted roles <span class="java&#45;keyword">this</span> one which gets past that restriction but
    &#42; doesn't grant anything.
    &#42;/
   <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> List NO_ROLES = &#91;<span class="java&#45;keyword">new</span> GrantedAuthorityImpl(SpringSecurityUtils.NO_ROLE)&#93;<p class="paragraph"/>   UserDetails loadUserByUsername(<span class="java&#45;object">String</span> username, <span class="java&#45;object">boolean</span> loadRoles)
            <span class="java&#45;keyword">throws</span> UsernameNotFoundException &#123;
      <span class="java&#45;keyword">return</span> loadUserByUsername(username)
   &#125;<p class="paragraph"/>   UserDetails loadUserByUsername(<span class="java&#45;object">String</span> username) <span class="java&#45;keyword">throws</span> UsernameNotFoundException &#123;<p class="paragraph"/>      User.withTransaction &#123; status &#45;&#62;<p class="paragraph"/>         User user = User.findByUsername(username)
         <span class="java&#45;keyword">if</span> (!user) <span class="java&#45;keyword">throw</span> <span class="java&#45;keyword">new</span> UsernameNotFoundException('User not found', username)<p class="paragraph"/>         def authorities = user.authorities.collect &#123;<span class="java&#45;keyword">new</span> GrantedAuthorityImpl(it.authority)&#125;<p class="paragraph"/>         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> MyUserDetails(user.username, user.password, user.enabled,
            !user.accountExpired, !user.passwordExpired,
            !user.accountLocked, authorities ?: NO_ROLES, user.id,
            user.firstName + <span class="java&#45;quote">" "</span> + user.lastName)
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>The lookup code is wrapped in a <code>withTransaction</code> block to avoid lazy loading exceptions when accessing the <code>authorities</code> collection. There are obviously no database updates here but this is a convenient way to keep the Hibernate <code>Session</code> open to enable accessing the roles.<p class="paragraph"/>To use your implementation, register it in <code>grails-app/conf/spring/resources.groovy</code> like this:<p class="paragraph"/><div class="code"><pre>beans = &#123;
   userDetailsService(com.mycompany.myapp.MyUserDetailsService)
&#125;</pre></div><p class="paragraph"/>Another option for loading users and roles from the database is to subclass <code>org.codehaus.groovy.grails.plugins.springsecurity.GormUserDetailsService</code> - the methods are all protected so you can override as needed.<p class="paragraph"/>This approach works with all beans defined in <code>SpringSecurityCoreGrailsPlugin.doWithSpring()</code> - you can replace or subclass any of the Spring beans to provide your own functionality when the standard extension mechanisms are insufficient.<p class="paragraph"/><h4>Flushing the Cached Authentication</h4>
If you store mutable data in your custom <code>UserDetails</code> implementation (such as full name in the preceding example), be sure to rebuild the <code>Authentication</code> if it changes. <code>springSecurityService</code> has a <code>reauthenticate</code> method that does this for you:<p class="paragraph"/><div class="code"><pre>class MyController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction &#123;
      def user = &#8230;
      // update user data
      user.save()
      springSecurityService.reauthenticate user.username
      &#8230;
   &#125;
&#125;</pre></div>

    
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
