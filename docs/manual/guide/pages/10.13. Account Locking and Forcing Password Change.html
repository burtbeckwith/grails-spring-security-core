<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>10.13. Account Locking and Forcing Password Change</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    Spring Security supports four ways of disabling a user account. When you attempt to log in, the <code>UserDetailsService</code> implementation creates an instance of <code>UserDetails</code> which has these accessors:
<ul class="star">
<li><code>isAccountNonExpired()</code></li>
<li><code>isAccountNonLocked()</code></li>
<li><code>isCredentialsNonExpired()</code></li>
<li><code>isEnabled()</code></li>
</ul><p class="paragraph"/>and if you use the <a href="../ref/Scripts/s2-quickstart.html" class="Scripts">s2-quickstart</a> script to create a user domain class, it creates a class with corresponding properties to manage this state.<p class="paragraph"/>When one of these accessors returns <code>false</code> (i.e. <code>accountExpired</code>, <code>accountLocked</code>, or <code>passwordExpired</code> is <code>true</code> or <code>enabled</code> is <code>false</code>)  a corresponding exception is thrown:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Accessor</strong></th><th><strong class="bold">Property</strong></th><th><strong class="bold">Exception</strong></th></tr><tr class="table-odd"><td><code>isAccountNonExpired()</code></td><td><code>accountExpired</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AccountExpiredException.html" target="blank">AccountExpiredException</a></td></tr><tr class="table-even"><td><code>isAccountNonLocked()</code></td><td><code>accountLocked</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/LockedException.html" target="blank">LockedException</a></td></tr><tr class="table-odd"><td><code>isCredentialsNonExpired()</code></td><td><code>passwordExpired</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/CredentialsExpiredException.html" target="blank">CredentialsExpiredException</a></td></tr><tr class="table-even"><td><code>isEnabled()</code></td><td><code>enabled</code></td><td><a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/DisabledException.html" target="blank">DisabledException</a></td></tr></table><p class="paragraph"/>You can configure an exception mapping in <code>Config.groovy</code> to associate a URL to any or all of these exceptions to determine where to redirect after a failure, e.g.<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.failureHandler.exceptionMappings = &#91;
   'org.springframework.security.authentication.LockedException':             '/user/accountLocked',
   'org.springframework.security.authentication.DisabledException':           '/user/accountDisabled',
   'org.springframework.security.authentication.AccountExpiredException':     '/user/accountExpired',
   'org.springframework.security.authentication.CredentialsExpiredException': '/user/passwordExpired'
&#93;</pre></div><p class="paragraph"/>Without a mapping for a particular exception, the user will be redirected to the standard login fail page (by default <code>/login/authfail</code>) like they would if they had entered a bad password, but they'll see an error message from this table:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default</strong></th></tr><tr class="table-odd"><td>errors.login.disabled</td><td>"Sorry, your account is disabled."</td></tr><tr class="table-even"><td>errors.login.expired</td><td>"Sorry, your account has expired."</td></tr><tr class="table-odd"><td>errors.login.passwordExpired</td><td>"Sorry, your password has expired."</td></tr><tr class="table-even"><td>errors.login.locked</td><td>"Sorry, your account is locked."</td></tr><tr class="table-odd"><td>errors.login.fail</td><td>"Sorry, we were not able to find a user with that username and password."</td></tr></table><p class="paragraph"/>Any of these can be customized by setting the corresponding property in <code>Config.groovy</code>, e.g.<p class="paragraph"/><div class="code"><pre>grails.plugins.springsecurity.errors.login.locked = <span class="java&#45;quote">"None shall pass."</span></pre></div><p class="paragraph"/>You can use this functionality to manually lock a user's account or expire the password, but another option would be to automate the process. For example you could use the <a href="http://grails.org/plugin/quartz" target="blank">Quartz plugin</a> to periodically expire everyone's password and force them to go to a page where they update it. You could also keep track of the date when the users change their passwords and use a Quartz job to expire their passwords once the password is older than some fixed max age.<p class="paragraph"/><h4>User cache</h4><p class="paragraph"/>If configured, Spring Security will cache <code>UserDetails</code> instances to save trips to the database. This is managed by the <code>cacheUsers</code> configuration property, and it defaults to <code>false</code> in the plugin but you can enable it if you wish. In general this is a minor optimization since there will most likely be only two small queries during login; one to load the user, and one to load the authorities.<p class="paragraph"/>If you enable this feature, you must remove any cached instances after making a change that affects login. If you don't, even though a user's account is locked or disabled, logins will still succeed since the database will be bypassed. By removing the cached data, you force them to go to the database and retrieve the latest updates.<p class="paragraph"/>Here is a sample Quartz job that demonstrates how you might find and disable users with passwords that are too old:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp<p class="paragraph"/>class ExpirePasswordsJob  &#123;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> triggers = &#123;
      cron name: 'myTrigger', cronExpression: '0 0 0 &#42; &#42; ?' // midnight daily
   &#125;<p class="paragraph"/>   def userCache<p class="paragraph"/>   void execute() &#123;<p class="paragraph"/>      def users = User.executeQuery(
            'from User u where u.passwordChangeDate &#60;= :cutoffDate',
            &#91;cutoffDate: <span class="java&#45;keyword">new</span> Date() &#45; 180&#93;)<p class="paragraph"/>      <span class="java&#45;keyword">for</span> (user in users) &#123;
         // flush each separately so one failure doesn't rollback all of the others
         <span class="java&#45;keyword">try</span> &#123;
            user.passwordExpired = <span class="java&#45;keyword">true</span>
            user.save(flush: <span class="java&#45;keyword">true</span>)
            userCache.removeUserFromCache user.username
         &#125;
         <span class="java&#45;keyword">catch</span> (e) &#123;
            log.error <span class="java&#45;quote">"problem expiring password <span class="java&#45;keyword">for</span> user $user.username : $e.message"</span>, e
         &#125;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>
    
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker('UA-16219500-1');
pageTracker._trackPageview();
} catch(err) {}
</script>

<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
