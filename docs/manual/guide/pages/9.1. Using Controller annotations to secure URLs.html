<html><head><meta content='text/html; charset=utf-8' http-equiv='Content-type'></meta><title>9.1. Using Controller annotations to secure URLs</title><link title='Ref' charset='utf-8' rel='stylesheet' type='text/css' href='../css/main.css' media='screen'></link></head><body><body class='body'><h4>Create your Grails application</h4><p class='paragraph'></p><pre class='bq'><code>
$ grails create-app bookstore
$ cd bookstore</code></pre><p class='paragraph'></p><h4>Install the plugin</h4><p class='paragraph'></p><pre class='bq'><code>
$ grails install-plugin spring-security-core</code></pre><p class='paragraph'></p><h4>Create the User and Role domain classes</h4><p class='paragraph'></p><pre class='bq'><code>
$ grails s2-quickstart com.testapp User Role</code></pre><p class='paragraph'></p>You can choose whatever names you like for your domain classes and the package they're in - these are just examples.<p class='paragraph'></p><blockquote class='note'>
Depending on your database, some names might not be valid. This goes for any domain classes you create, but names for security seem to have an affinity towards trouble. So before you use names like "User" or "Group", make sure they are not reserved keywords in your database.
</blockquote><p class='paragraph'></p>The script will create this User class:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> com.testapp<p class='paragraph'></p>class User {<p class='paragraph'></p><span class='java-object'>String</span> username
   <span class='java-object'>String</span> password
   <span class='java-object'>boolean</span> enabled
   <span class='java-object'>boolean</span> accountExpired
   <span class='java-object'>boolean</span> accountLocked
   <span class='java-object'>boolean</span> passwordExpired<p class='paragraph'></p><span class='java-keyword'>static</span> constraints = {
      username blank: <span class='java-keyword'>false</span>, unique: <span class='java-keyword'>true</span>
      password blank: <span class='java-keyword'>false</span>
   }<p class='paragraph'></p><span class='java-keyword'>static</span> mapping = {
      password column: '`password`'
   }<p class='paragraph'></p>   Set&lt;Role&gt; getAuthorities() {
      UserRole.findAllByUser(<span class='java-keyword'>this</span>).collect { it.role } as Set
   }
}</pre></div><p class='paragraph'></p>and this Role class:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> com.testapp<p class='paragraph'></p>class Role {<p class='paragraph'></p><span class='java-object'>String</span> authority<p class='paragraph'></p><span class='java-keyword'>static</span> mapping = {
      cache <span class='java-keyword'>true</span>
   }<p class='paragraph'></p><span class='java-keyword'>static</span> constraints = {
      authority blank: <span class='java-keyword'>false</span>, unique: <span class='java-keyword'>true</span>
   }
}</pre></div><p class='paragraph'></p>and a domain class that maps the many-to-many join class, <code>UserRole</code>:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> com.testapp<p class='paragraph'></p><span class='java-keyword'>import</span> org.apache.commons.lang.builder.HashCodeBuilder<p class='paragraph'></p>class UserRole <span class='java-keyword'>implements</span> Serializable {<p class='paragraph'></p>   User user
   Role role<p class='paragraph'></p><span class='java-object'>boolean</span> equals(other) {
      <span class='java-keyword'>if</span> (!(other <span class='java-keyword'>instanceof</span> UserRole)) {
         <span class='java-keyword'>return</span><span class='java-keyword'>false</span>
      }<p class='paragraph'></p>      other.user?.id == user?.id &amp;&amp;
         other.role?.id == role?.id
   }<p class='paragraph'></p><span class='java-object'>int</span> hashCode() {
      def builder = <span class='java-keyword'>new</span> HashCodeBuilder()
      <span class='java-keyword'>if</span> (user) builder.append(user.id)
      <span class='java-keyword'>if</span> (role) builder.append(role.id)
      builder.toHashCode()
   }<p class='paragraph'></p><span class='java-keyword'>static</span> UserRole get(<span class='java-object'>long</span> userId, <span class='java-object'>long</span> roleId) {
      find 'from UserRole where user.id=:userId and role.id=:roleId',
         [userId: userId, roleId: roleId]
   }<p class='paragraph'></p><span class='java-keyword'>static</span> UserRole create(User user, Role role, <span class='java-object'>boolean</span> flush = <span class='java-keyword'>false</span>) {
      <span class='java-keyword'>new</span> UserRole(user: user, role: role).save(flush: flush, insert: <span class='java-keyword'>true</span>)
   }<p class='paragraph'></p><span class='java-keyword'>static</span><span class='java-object'>boolean</span> remove(User user, Role role, <span class='java-object'>boolean</span> flush = <span class='java-keyword'>false</span>) {
      UserRole instance = UserRole.findByUserAndRole(user, role)
      instance ? instance.delete(flush: flush) : <span class='java-keyword'>false</span>
   }<p class='paragraph'></p><span class='java-keyword'>static</span> void removeAll(User user) {
      executeUpdate 'DELETE FROM UserRole WHERE user=:user', [user: user]
   }<p class='paragraph'></p><span class='java-keyword'>static</span> mapping = {
      id composite: ['role', 'user']
      version <span class='java-keyword'>false</span>
   }
}</pre></div><p class='paragraph'></p>It also creates some UI controllers and GSPs:
<ul class='star'><li><code>grails-app/controllers/LoginController.groovy</code></li><li><code>grails-app/controllers/LogoutController.groovy</code></li><li><code>grails-app/views/auth.gsp</code></li><li><code>grails-app/views/denied.gsp</code></li></ul><p class='paragraph'></p>Note that the script has edited <code>grails-app/conf/Config.groovy</code> and added the configuration for your domain classes. Make sure that the changes are correct.<p class='paragraph'></p><blockquote class='note'>
These generated files are not part of the plugin - these are your application files. So you're free to edit them however you like - they're examples to get you started. They only contain the minimum needed for the plugin, but you're free to add whatever extra fields and methods you like.
</blockquote><p class='paragraph'></p>The plugin has no support for CRUD actions and GSPs for your domain classes, the <code>spring-security-ui</code> plugin will supply a UI for those. So for now we'll create roles and users in <code>grails-app/conf/BootStrap.groovy</code><p class='paragraph'></p><h4>Create a controller that will be restricted by role</h4><p class='paragraph'></p><pre class='bq'><code>
$ grails create-controller com.testapp.Secure</code></pre><p class='paragraph'></p>This will create <code>grails-app/controllers/com/testapp/SecureController.groovy</code> - add some output so we can verify that things are working:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> com.testapp<p class='paragraph'></p>class SecureController {
   def index = {
      render 'Secure access only'
   }
}</pre></div><p class='paragraph'></p><h4>Start the server</h4><p class='paragraph'></p><pre class='bq'><code>
$ grails run-app</code></pre><p class='paragraph'></p>Before we secure the page, navigate to <a target='blank' href='http://localhost:8080/bookstore/secure'>http://localhost:8080/bookstore/secure</a> to verify that you can see the page without being logged in.<p class='paragraph'></p>Shut down the app (using CTRL-C) and edit <code>grails-app/conf/BootStrap.groovy</code> to add the security objects that we need:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>import</span> com.testapp.Role
<span class='java-keyword'>import</span> com.testapp.User
<span class='java-keyword'>import</span> com.testapp.UserRole<p class='paragraph'></p>class BootStrap {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def init = { servletContext -&gt;<p class='paragraph'></p>      def adminRole = <span class='java-keyword'>new</span> Role(authority: 'ROLE_ADMIN').save(flush: <span class='java-keyword'>true</span>)
      def userRole = <span class='java-keyword'>new</span> Role(authority: 'ROLE_USER').save(flush: <span class='java-keyword'>true</span>)<p class='paragraph'></p><span class='java-object'>String</span> password = springSecurityService.encodePassword('password')
      def testUser = <span class='java-keyword'>new</span> User(username: 'me', enabled: <span class='java-keyword'>true</span>, password: password)
      testUser.save(flush: <span class='java-keyword'>true</span>)<p class='paragraph'></p>      UserRole.create testUser, adminRole, <span class='java-keyword'>true</span><p class='paragraph'></p>      assert User.count() == 1
      assert Role.count() == 2
      assert UserRole.count() == 1
   }
}</pre></div><p class='paragraph'></p>Some things to note about what we did in <code>BootStrap.groovy</code>:
<ul class='star'><li>we use <code>springSecurityService</code> to encrypt the password</li><li>we're not using a traditional GORM many-to-many mapping for the User&lt;-&gt;Role relationship, instead we're mapping the join table with the <code>UserRole</code> class. This is a performance optimization that will help significantly if many users have one or more common roles</li><li>we're explicitly flushing the creates since <code>BootStrap</code> doesn't run in a transaction or OpenSessionInView</li></ul><p class='paragraph'></p>Edit <code>grails-app/controllers/SecureController.groovy</code> to import the annotation class and apply the annotation to restrict access:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> com.testapp<p class='paragraph'></p><span class='java-keyword'>import</span> grails.plugins.springsecurity.Secured<p class='paragraph'></p>class SecureController {<p class='paragraph'></p>   @Secured(['ROLE_ADMIN'])
   def index = {
      render 'Secure access only'
   }
}</pre></div><p class='paragraph'></p>or<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> com.testapp<p class='paragraph'></p><span class='java-keyword'>import</span> grails.plugins.springsecurity.Secured<p class='paragraph'></p>@Secured(['ROLE_ADMIN'])
class SecureController {
   def index = {
      render 'Secure access only'
   }
}</pre></div><p class='paragraph'></p>You can annotate the entire controller or individual actions. In this case since we only have one action we can do either.<p class='paragraph'></p>Now run <code>grails run-app</code> again and navigate to <a target='blank' href='http://localhost:8080/bookstore/secure'>http://localhost:8080/bookstore/secure</a> and this time, you should be presented with the login page. Log in with the username and password you used for the test user, and you should again be able to see the secure page.<p class='paragraph'></p>When logging in, you can test the Remember Me functionality. Check the checkbox, and once you've tested the secure page close your browser and re-open it. Navigate again the the secure page, and since you have a cookie stored, you shouldn't need to log in again. Logout at any time by navigating to <a target='blank' href='http://localhost:8080/bookstore/logout'>http://localhost:8080/bookstore/logout</a><p class='paragraph'></p><h4>Creating a UI</h4><p class='paragraph'></p>If you would like to have a CRUD UI to work with users and roles, there are a few things you need to do beyond running <code>grails generate-all</code>.<p class='paragraph'></p>The generated <code>UserController.save</code> action will look something like this:<p class='paragraph'></p><div class='code'><pre>def save = {
   def userInstance = <span class='java-keyword'>new</span> User(params)
   <span class='java-keyword'>if</span> (userInstance.save(flush: <span class='java-keyword'>true</span>)) {
      flash.message = <span class='java-quote'>"${message(code: '<span class='java-keyword'>default</span>.created.message', args: [message(code: 'user.label', <span class='java-keyword'>default</span>: 'User'), userInstance.id])}"</span>
      redirect(action: <span class='java-quote'>"show"</span>, id: userInstance.id)
   }
   <span class='java-keyword'>else</span> {
      render(view: <span class='java-quote'>"create"</span>, model: [userInstance: userInstance])
   }
}</pre></div><p class='paragraph'></p>This will store cleartext passwords and you won't be able to authenticate, so add a call to encrypt the password with <code>springSecurityService</code>:<p class='paragraph'></p><div class='code'><pre>class UserController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   ...<p class='paragraph'></p>   def save = {
      def userInstance = <span class='java-keyword'>new</span> User(params)
      userInstance.password = springSecurityService.encodePassword(params.password)
      <span class='java-keyword'>if</span> (userInstance.save(flush: <span class='java-keyword'>true</span>)) {
         flash.message = <span class='java-quote'>"${message(code: '<span class='java-keyword'>default</span>.created.message', args: [message(code: 'user.label', <span class='java-keyword'>default</span>: 'User'), userInstance.id])}"</span>
         redirect(action: <span class='java-quote'>"show"</span>, id: userInstance.id)
      }
      <span class='java-keyword'>else</span> {
         render(view: <span class='java-quote'>"create"</span>, model: [userInstance: userInstance])
      }
   }
}</pre></div><p class='paragraph'></p>Similarly when updating you'll need to encrypt the password if it changes. Change this:<p class='paragraph'></p><div class='code'><pre>def update = {
   def userInstance = User.get(params.id)
   <span class='java-keyword'>if</span> (userInstance) {
      <span class='java-keyword'>if</span> (params.version) {
         def version = params.version.toLong()
         &#x2026;
      }
      userInstance.properties = params
      <span class='java-keyword'>if</span> (!userInstance.hasErrors() &amp;&amp; userInstance.save(flush: <span class='java-keyword'>true</span>)) {
         flash.message = <span class='java-quote'>"${message(code: '<span class='java-keyword'>default</span>.updated.message', args: [message(code: 'user.label', <span class='java-keyword'>default</span>: 'User'), userInstance.id])}"</span>
         redirect(action: <span class='java-quote'>"show"</span>, id: userInstance.id)
      }
      <span class='java-keyword'>else</span> {
         render(view: <span class='java-quote'>"edit"</span>, model: [userInstance: userInstance])
      }
   }
   <span class='java-keyword'>else</span> {
      flash.message = <span class='java-quote'>"${message(code: '<span class='java-keyword'>default</span>.not.found.message', args: [message(code: 'user.label', <span class='java-keyword'>default</span>: 'User'), params.id])}"</span>
      redirect(action: <span class='java-quote'>"list"</span>)
   }
}</pre></div><p class='paragraph'></p>to<p class='paragraph'></p><div class='code'><pre>def update = {
   def userInstance = User.get(params.id)
   <span class='java-keyword'>if</span> (userInstance) {
      <span class='java-keyword'>if</span> (params.version) {
         def version = params.version.toLong()
         &#x2026;
      }
      <span class='java-keyword'>if</span> (userInstance.password != params.password) {
         params.password = springSecurityService.encodePassword(params.password)
      }
      userInstance.properties = params
      <span class='java-keyword'>if</span> (!userInstance.hasErrors() &amp;&amp; userInstance.save(flush: <span class='java-keyword'>true</span>)) {
         <span class='java-keyword'>if</span> (springSecurityService.loggedIn &amp;&amp;
                springSecurityService.principal.username == userInstance.username) {
            springSecurityService.reauthenticate userInstance.username
         }
         flash.message = <span class='java-quote'>"${message(code: '<span class='java-keyword'>default</span>.updated.message', args: [message(code: 'user.label', <span class='java-keyword'>default</span>: 'User'), userInstance.id])}"</span>
         redirect(action: <span class='java-quote'>"show"</span>, id: userInstance.id)
      }
      <span class='java-keyword'>else</span> {
         render(view: <span class='java-quote'>"edit"</span>, model: [userInstance: userInstance])
      }
   }
   <span class='java-keyword'>else</span> {
      flash.message = <span class='java-quote'>"${message(code: '<span class='java-keyword'>default</span>.not.found.message', args: [message(code: 'user.label', <span class='java-keyword'>default</span>: 'User'), params.id])}"</span>
      redirect(action: <span class='java-quote'>"list"</span>)
   }
}</pre></div><p class='paragraph'></p>Note that there's also a call to <code>springSecurityService.reauthenticate()</code> to ensure that the cached <code>Authentication</code> stays current.<p class='paragraph'></p>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body></html>