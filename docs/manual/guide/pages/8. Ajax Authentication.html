<html><head><meta content='text/html; charset=utf-8' http-equiv='Content-type'></meta><title>8. Ajax Authentication</title><link title='Ref' charset='utf-8' rel='stylesheet' type='text/css' href='../css/main.css' media='screen'></link></head><body><body class='body'>
    The typical pattern of using web site authentication to access restricted pages involves intercepting access requests for secure pages, redirecting to a login page (possibly off-site) and redirecting back to the originally-requested page after a successful login. Each page can also have a login link to allow explicit logins at any time.<p class='paragraph'></p>Another option is to also have a login link on each page and use Ajax and DHTML to present a login form within the current page in a popup. The form submits the authentication request via Ajax and displays success or error messages as appropriate.<p class='paragraph'></p>The plugin has support for Ajax logins but you'll need to create your own GSP code. There are only a few necessary changes, and of course the sample code here is pretty basic so you should enhance it for your needs.<p class='paragraph'></p>The approach I'll show here involves editing your template page(s) to show "You're logged in as ..." text if logged in and a login link if not, along with a hidden login form that's shown using DHTML.<p class='paragraph'></p>Here's the updated <code>grails-app/views/layouts/main.gsp</code>:<p class='paragraph'></p><div class='code'><pre>&lt;html&gt;<p class='paragraph'></p>&lt;head&gt;
&lt;title&gt;&lt;g:layoutTitle <span class='java-keyword'>default</span>=<span class='java-quote'>"Grails"</span> /&gt;&lt;/title&gt;
&lt;link rel=<span class='java-quote'>"stylesheet"</span> href=<span class='java-quote'>"${resource(dir:'css',file:'main.css')}"</span> /&gt;
&lt;link rel=<span class='java-quote'>"shortcut icon"</span> type=<span class='java-quote'>"image/x-icon"</span>
      href=<span class='java-quote'>"${resource(dir:'images',file:'favicon.ico')}"</span> /&gt;
&lt;g:layoutHead /&gt;
&lt;/head&gt;<p class='paragraph'></p>&lt;body&gt;<p class='paragraph'></p>   &lt;div id=<span class='java-quote'>"spinner"</span> class=<span class='java-quote'>"spinner"</span> style=<span class='java-quote'>"display:none;"</span>&gt;
      &lt;img src=<span class='java-quote'>"${resource(dir:'images',file:'spinner.gif')}"</span> alt=<span class='java-quote'>"Spinner"</span> /&gt;
   &lt;/div&gt;<p class='paragraph'></p>   &lt;div id=<span class='java-quote'>"grailsLogo"</span> class=<span class='java-quote'>"logo"</span>&gt;
      &lt;a href=<span class='java-quote'>"http://grails.org"</span>&gt;
         &lt;img src=<span class='java-quote'>"${resource(dir:'images',file:'grails_logo.png')}"</span> alt=<span class='java-quote'>"Grails"</span> border=<span class='java-quote'>"0"</span> /&gt;
      &lt;/a&gt;<p class='paragraph'></p>      &lt;span id='loginLink' style='position: relative; margin-right: 30px; <span class='java-object'>float</span>: right'&gt;
      &lt;sec:ifLoggedIn&gt;
         Logged in as &lt;sec:username/&gt; (&lt;g:link controller='logout'&gt;Logout&lt;/g:link&gt;)
      &lt;/sec:ifLoggedIn&gt;
      &lt;sec:ifNotLoggedIn&gt;
         &lt;a href='#' onclick='showLogin(); <span class='java-keyword'>return</span><span class='java-keyword'>false</span>;'&gt;Login&lt;/a&gt;
      &lt;/sec:ifNotLoggedIn&gt;
      &lt;/span&gt;<p class='paragraph'></p>   &lt;/div&gt;<p class='paragraph'></p>   &lt;g:javascript src='application.js' /&gt;
   &lt;g:javascript library='prototype' /&gt;
   &lt;g:javascript src='prototype/scriptaculous.js?load=effects' /&gt;<p class='paragraph'></p>   &lt;g:render template='/includes/ajaxLogin'/&gt;<p class='paragraph'></p>   &lt;g:layoutBody /&gt;<p class='paragraph'></p>   &lt;/body&gt;
&lt;/html&gt;</pre></div><p class='paragraph'></p>The changes to note here include:
<ul class='star'><li>the prototype and scriptaculous libraries are included for Ajax support and to hide and show the login form</li><li>there's an include of the template <code>/includes/ajaxLogin</code> (see the code below)</li><li>there's a &lt;span&gt; positioned in the top-right which shows the username and a logout link when logged in, and a login link otherwise</li></ul><p class='paragraph'></p>Here's the content of the login form template (<code>grails-app/views/includes/_ajaxLogin.gsp</code>) - note that the CSS and Javascript are shown inline, but should be extracted to their own static files:<p class='paragraph'></p><div class='code'><pre>&lt;style&gt;
#ajaxLogin {
   margin: 15px 0px; padding: 0px;
   text-align: center;
   display: none;
   position: absolute;
}
#ajaxLogin .<span class='java-keyword'>inner</span> {
   width: 260px;
   margin:0px auto;
   text-align:left;
   padding:10px;
   border-top:1px dashed #499ede;
   border-bottom:1px dashed #499ede;
   background-color:#EEF;
}
#ajaxLogin .<span class='java-keyword'>inner</span> .fheader {
   padding:4px;margin:3px 0px 3px 0;color:#2e3741;font-size:14px;font-weight:bold;
}
#ajaxLogin .<span class='java-keyword'>inner</span> .cssform p {
   clear: left;
   margin: 0;
   padding: 5px 0 8px 0;
   padding-left: 105px;
   border-top: 1px dashed gray;
   margin-bottom: 10px;
   height: 1%;
}
#ajaxLogin .<span class='java-keyword'>inner</span> .cssform input[type='text'] {
   width: 120px;
}
#ajaxLogin .<span class='java-keyword'>inner</span> .cssform label{
   font-weight: bold;
   <span class='java-object'>float</span>: left;
   margin-left: -105px;
   width: 100px;
}
#ajaxLogin .<span class='java-keyword'>inner</span> .login_message {color:red;}
#ajaxLogin .<span class='java-keyword'>inner</span> .text_ {width:120px;}
#ajaxLogin .<span class='java-keyword'>inner</span> .chk {height:12px;}
.errorMessage { color: red; }
&lt;/style&gt;<p class='paragraph'></p>&lt;div id='ajaxLogin'&gt;
   &lt;div class='<span class='java-keyword'>inner</span>'&gt;
   &lt;div class='fheader'&gt;Please Login..&lt;/div&gt;
   &lt;form action='${request.contextPath}/j_spring_security_check' method='POST'
       id='ajaxLoginForm' name='ajaxLoginForm' class='cssform'&gt;
      &lt;p&gt;
         &lt;label <span class='java-keyword'>for</span>='username'&gt;Login ID&lt;/label&gt;
         &lt;input type='text' class='text_' name='j_username' id='username' /&gt;
      &lt;/p&gt;
      &lt;p&gt;
         &lt;label <span class='java-keyword'>for</span>='password'&gt;Password&lt;/label&gt;
         &lt;input type='password' class='text_' name='j_password' id='password' /&gt;
      &lt;/p&gt;
      &lt;p&gt;
         &lt;label <span class='java-keyword'>for</span>='remember_me'&gt;Remember me&lt;/label&gt;
         &lt;input type='checkbox' class='chk' id='remember_me'
                name='_spring_security_remember_me'/&gt;
      &lt;/p&gt;
      &lt;p&gt;
         &lt;a href='javascript:void(0)' onclick='authAjax(); <span class='java-keyword'>return</span><span class='java-keyword'>false</span>;'&gt;Login&lt;/a&gt;
         &lt;a href='javascript:void(0)' onclick='cancelLogin(); <span class='java-keyword'>return</span><span class='java-keyword'>false</span>;'&gt;Cancel&lt;/a&gt;
      &lt;/p&gt;
   &lt;/form&gt;
    &lt;div style='display: none; text-align: left;' id='loginMessage'&gt;&lt;/div&gt;
   &lt;/div&gt;
&lt;/div&gt;<p class='paragraph'></p>&lt;script type='text/javascript'&gt;<p class='paragraph'></p>// center the form
Event.observe(window, 'load', function() {
   <span class='java-keyword'>var</span> ajaxLogin = $('ajaxLogin');
   $('ajaxLogin').style.left = ((document.body.getDimensions().width -
                                 ajaxLogin.getDimensions().width) / 2) + 'px';
   $('ajaxLogin').style.top = ((document.body.getDimensions().height -
                                ajaxLogin.getDimensions().height) / 2) + 'px';
});<p class='paragraph'></p>function showLogin() {
   $('ajaxLogin').style.display = 'block';
}<p class='paragraph'></p>function cancelLogin() {
   Form.enable(document.ajaxLoginForm);
   Element.hide('ajaxLogin');
}<p class='paragraph'></p>function authAjax() {
   Form.enable(document.ajaxLoginForm);
   Element.update('loginMessage', 'Sending request ...');
   Element.show('loginMessage');<p class='paragraph'></p><span class='java-keyword'>var</span> form = document.ajaxLoginForm;
   <span class='java-keyword'>var</span> params = Form.serialize(form);
   Form.disable(form);
   <span class='java-keyword'>new</span> Ajax.Request(form.action, {
      method: 'POST',
      postBody: params,
      onSuccess: function(response) {
         Form.enable(document.ajaxLoginForm);
         <span class='java-keyword'>var</span> responseText = response.responseText || '[]';
         <span class='java-keyword'>var</span> json = responseText.evalJSON();
         <span class='java-keyword'>if</span> (json.success) {
            Element.hide('ajaxLogin');
            $('loginLink').update('Logged in as ' + json.username +
                                  ' (&lt;%=link(controller: 'logout') { 'Logout' }%&gt;)');
         }
         <span class='java-keyword'>else</span><span class='java-keyword'>if</span> (json.error) {
            Element.update('loginMessage', <span class='java-quote'>"&lt;span class='errorMessage'&gt;"</span> +
                                           json.error + '&lt;/error&gt;');
         }
         <span class='java-keyword'>else</span> {
            Element.update('loginMessage', responseText);
         }
      }
   });
}
&lt;/script&gt;</pre></div><p class='paragraph'></p>The important aspects of this code are:
<ul class='star'><li>the form posts to the same url as the regular form, <code>j_spring_security_check</code>; in fact the form is identical including the Remember Me checkbox, except that the submit button has been replaced with a hyperlink</li><li>error messages are displayed within the popup &lt;div&gt;</li><li>since there's no page redirect after successful login, the Javascript replaces the login link to give a visual indication that the user is logged in</li><li>details of logout are not shown, but this is achieved by redirecting the user to <code>/j_spring_security_logout</code></li></ul><p class='paragraph'></p><h4>So how does it work?</h4><p class='paragraph'></p>Most Ajax libraries (Prototype, JQuery, and Dojo as of v2.1) include an <code>X-Requested-With</code> header that indicates that the request was made by <code>XMLHttpRequest</code> instead of being triggered by clicking a regular hyperlink or form submit button. The plugin uses this header to detect Ajax login requests, and uses subclasses of some of Spring Security's classes to use different redirect urls for Ajax requests than regular requests. Instead of showing full pages, <code>LoginController</code> has JSON-generating methods <code>ajaxSuccess()</code>, <code>ajaxDenied()</code>, and <code>authfail()</code> that generate JSON that the login Javascript code can use to appropriately display success or error messages.<p class='paragraph'></p>You can see the Ajax-aware actions in <code>LoginController</code>, specifically <code>ajaxSuccess</code> and <code>ajaxDenied</code>, which send JSON responses that can be used by client JavaScript code. Also <code>authfail</code> will check whether the authentication request used Ajax and will render a JSON error response if it was.

    
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body></html>