<html><head><meta content='text/html; charset=utf-8' http-equiv='Content-type'></meta><title>4. Helper Classes</title><link title='Ref' charset='utf-8' rel='stylesheet' type='text/css' href='../css/main.css' media='screen'></link></head><body><body class='body'><h1><a name='4. Helper Classes'>4. Helper Classes</a></h1>The plugin has a few helper classes that you can use in your application to avoid having to deal with the lower-level details of Spring Security.
<h2><a name='4.1. Security Tags'>4.1. Security Tags</a></h2>The plugin comes with a few GSP tags to support conditional display based on whether the user is authenticated, and/or has the required role to perform some action. All of the tags are in the <code>sec</code> namespace and are implemented in <code>grails.plugins.springsecurity.SecurityTagLib</code>.<p class='paragraph'></p><h4>ifLoggedIn</h4><p class='paragraph'></p>Displays the inner body content if the user is authenticated.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>&lt;sec:ifLoggedIn&gt;
Welcome Back!
&lt;/sec:ifLoggedIn&gt;</pre></div><p class='paragraph'></p><h4>ifNotLoggedIn</h4><p class='paragraph'></p>Displays the inner body content if the user is not authenticated.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>&lt;sec:ifNotLoggedIn&gt;
&lt;g:link controller='login' action='auth'&gt;Login&lt;/g:link&gt;
&lt;/sec:ifNotLoggedIn&gt;</pre></div><p class='paragraph'></p><h4>ifAllGranted</h4><p class='paragraph'></p>Displays the inner body content only if all of the listed roles are granted.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>&lt;sec:ifAllGranted roles=<span class='java-quote'>"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&gt;secure stuff here&lt;/sec:ifAllGranted&gt;</pre></div><p class='paragraph'></p><h4>ifAnyGranted</h4><p class='paragraph'></p>Displays the inner body content if at least one of the listed roles are granted.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>&lt;sec:ifAnyGranted roles=<span class='java-quote'>"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&gt;secure stuff here&lt;/sec:ifAnyGranted&gt;</pre></div><p class='paragraph'></p><h4>ifNotGranted</h4><p class='paragraph'></p>Displays the inner body content if none of the listed roles are granted.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>&lt;sec:ifNotGranted roles=<span class='java-quote'>"ROLE_USER"</span>&gt;non-user stuff here&lt;/sec:ifNotGranted&gt;</pre></div><p class='paragraph'></p><h4> loggedInUserInfo</h4><p class='paragraph'></p>Displays the value of the specified authentication field if logged in. For example this will show the username property:<p class='paragraph'></p><div class='code'><pre>&lt;sec:loggedInUserInfo field=<span class='java-quote'>"username"</span>/&gt;</pre></div><p class='paragraph'></p>and if you have customized the authentication to add a <code>fullName</code> property, you would access it using<p class='paragraph'></p><div class='code'><pre>Welcome Back &lt;sec:loggedInUserInfo field=<span class='java-quote'>"fullName"</span>/&gt;</pre></div><p class='paragraph'></p><h4> username</h4><p class='paragraph'></p>Displays the value of the authentication <code>username</code> field if logged in.<p class='paragraph'></p><div class='code'><pre>&lt;sec:ifLoggedIn&gt;
Welcome Back &lt;sec:username/&gt;!
&lt;/sec:ifLoggedIn&gt;
&lt;sec:ifNotLoggedIn&gt;
&lt;g:link controller='login' action='auth'&gt;Login&lt;/g:link&gt;
&lt;/sec:ifNotLoggedIn&gt;</pre></div><p class='paragraph'></p><h4>ifSwitched</h4><p class='paragraph'></p>Displays the inner body content only if the current user switched from another user.<p class='paragraph'></p><div class='code'><pre>&lt;sec:ifLoggedIn&gt;
Logged in as &lt;sec:username/&gt;
&lt;/sec:ifLoggedIn&gt;<p class='paragraph'></p>&lt;sec:ifSwitched&gt;
&lt;a href='${request.contextPath}/j_spring_security_exit_user'&gt;
   Resume as &lt;sec:switchedUserOriginalUsername/&gt;
&lt;/a&gt;
&lt;/sec:ifSwitched&gt;<p class='paragraph'></p>&lt;sec:ifNotSwitched&gt;<p class='paragraph'></p>   &lt;sec:ifAllGranted roles='ROLE_SWITCH_USER'&gt;<p class='paragraph'></p>   &lt;form action='${request.contextPath}/j_spring_security_switch_user' method='POST'&gt;<p class='paragraph'></p>      Switch to user: &lt;input type='text' name='j_username'/&gt;&lt;br/&gt;<p class='paragraph'></p>      &lt;input type='submit' value='Switch'/&gt; &lt;/form&gt;<p class='paragraph'></p>   &lt;/sec:ifAllGranted&gt;<p class='paragraph'></p>&lt;/sec:ifNotSwitched&gt;</pre></div><p class='paragraph'></p><h4>ifNotSwitched</h4><p class='paragraph'></p>Displays the inner body content only if the current user has not switched from another user.<p class='paragraph'></p><h4>switchedUserOriginalUsername</h4><p class='paragraph'></p>Renders the original user's username if the current user switched from another user.<p class='paragraph'></p><h2><a name='4.2. SpringSecurityService'>4.2. SpringSecurityService</a></h2><code>grails.plugins.springsecurity.SpringSecurityService</code> provides security utility functions. It's a regular Grails service, so you can use dependency injection to inject it into a controller, service, taglib, etc.:<p class='paragraph'></p><div class='code'><pre>def springSecurityService</pre></div><p class='paragraph'></p><h4>isLoggedIn()</h4><p class='paragraph'></p>Checks to see if there's a currently logged-in user.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class SomeController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def someAction = {
      <span class='java-keyword'>if</span> (springSecurityService.isLoggedIn()) {
         &#x2026;
      }
      <span class='java-keyword'>else</span> {
         &#x2026;
      }
   }
}</pre></div><p class='paragraph'></p><h4>getAuthentication()</h4><p class='paragraph'></p>Retrieves the current user's <a target='blank' href='http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html'>Authentication</a> if logged in, or <code>null</code> otherwise.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class SomeController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def someAction = {
      def auth = springSecurityService.authentication
      <span class='java-object'>String</span> username = auth.username
      def authorities = auth.authorities // a Collection of GrantedAuthority
      <span class='java-object'>boolean</span> authenticated = auth.authenticated
      &#x2026;
   }
}</pre></div><p class='paragraph'></p><h4>getPrincipal()</h4><p class='paragraph'></p>Retrieves the currently logged in user's <code>Principal</code>, or <code>null</code> if not logged in. This will be a <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code> unless you've created a custom <code>UserDetailsService</code>, in which case it'll be whatever implementation of <a target='blank' href='http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetails.html'>UserDetails</a> you use there.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class SomeController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def someAction = {
      def principal = springSecurityService.principal
      <span class='java-object'>String</span> username = principal.username
      def authorities = principal.authorities // a Collection of GrantedAuthority
      <span class='java-object'>boolean</span> enabled = principal.enabled
      &#x2026;
   }
}</pre></div><p class='paragraph'></p><h4>encodePassword()</h4><p class='paragraph'></p>Encrypts a password using the configured encryption scheme. By default the plugin uses SHA-256, but this is configurable using the <code>grails.plugins.springsecurity.password.algorithm</code> attribute in <code>Config.groovy</code>. You can use any message digest algorithm that's supported in your JDK; see <a target='blank' href='http://java.sun.com/j2se/1.5.0/docs/guide/security/CryptoSpec.html#AppA'>this page</a> for information on what's available. In particular you are <strong class='bold'>strongly</strong> discouraged from using MD5 or SHA-1 algorithms since they are rather weak and have well-known vulnerabilities. You should also use a salt for your passwords, which greatly increases the computational complexity of decrypting passwords if your database gets compromised. See <a class='guide' href='../guide/single.html#10.5. Salted passwords'>here</a> for details on using salted passwords.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class PersonController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def updateAction = {
      def person = Person.get(params.id)<p class='paragraph'></p>      params.salt = person.salt
      <span class='java-keyword'>if</span> (person.password != params.password) {
         params.password = springSecurityService.encodePassword(password, salt)
         def salt = &#x2026; // e.g. randomly generated using some utility method
         params.salt = salt
      }
      person.properties = params
      <span class='java-keyword'>if</span> (!person.save(flush: <span class='java-keyword'>true</span>)) {
         render view: 'edit', model: [person: person]
         <span class='java-keyword'>return</span>
      }
      redirect action: show, id: person.id
   }
}</pre></div><p class='paragraph'></p><h4>updateRole()</h4><p class='paragraph'></p>Updates a role and if you're using <code>Requestmap</code> instances to manage securing URLs, will replace the new role name in all <code>Requestmap</code> definitions that use it if the name was changed.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class RoleController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def update = {
      def roleInstance = Role.get(params.id)
      <span class='java-keyword'>if</span> (!springSecurityService.updateRole(roleInstance, params)) {
         render view: 'edit', model: [roleInstance: roleInstance]
         <span class='java-keyword'>return</span>
      }<p class='paragraph'></p>      flash.message = <span class='java-quote'>"The role was updated"</span>
      redirect action: show, id: roleInstance.id
   }
}</pre></div><p class='paragraph'></p><h4>deleteRole()</h4><p class='paragraph'></p>Deletes a role and if you're using <code>Requestmap</code> instances to manage securing URLs, will remove the role from all <code>Requestmap</code> definitions. If a <code>Requestmap</code>'s config attribute is just this role's name (e.g. "/foo/bar/<strong class='bold'></strong>=ROLE_FOO") it will be deleted.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class RoleController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def delete = {
      def roleInstance = Role.get(params.id)
      <span class='java-keyword'>try</span> {
         springSecurityService.deleteRole (roleInstance
         flash.message = <span class='java-quote'>"The role was deleted"</span>
         redirect action: list
      }
      <span class='java-keyword'>catch</span> (DataIntegrityViolationException e) {
         flash.message = <span class='java-quote'>"Unable to delete the role"</span>
         redirect action: show, id: params.id
      }
   }
}</pre></div><p class='paragraph'></p><h4>clearCachedRequestmaps()</h4><p class='paragraph'></p>If you're using <code>Requestmap</code> instances to manage securing URLs, the plugin will load and cache all <code>Requestmap</code> instances as a performance optimization. This saves a lot of database activity since the requestmaps are checked for each request. But you can't allow the cache to become stale, so when you create, edit or delete a <code>Requestmap</code> you should flush the cache to trigger a complete reload. Both <code>updateRole()</code> and <code>deleteRole()</code> call this method for you, so you should call this when you create a new <code>Requestmap</code> or if you do some other <code>Requestmap</code> work that would affect the cache.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class RequestmapController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def save = {
      def requestmapInstance = <span class='java-keyword'>new</span> Requestmap(params)
      <span class='java-keyword'>if</span> (!requestmapInstance.save(flush: <span class='java-keyword'>true</span>)) {
         render view: 'create', model: [requestmapInstance: requestmapInstance]
         <span class='java-keyword'>return</span>
      }<p class='paragraph'></p>      springSecurityService.clearCachedRequestmaps()
      flash.message = <span class='java-quote'>"Requestmap created"</span>
      redirect action: show, id: requestmapInstance.id
   }
}</pre></div><p class='paragraph'></p><h4>reauthenticate()</h4><p class='paragraph'></p>Rebuilds an <a target='blank' href='http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html'>Authentication</a> for the given username and registers it in the security context. This is typically used after updating a user's authorities or other data that is cached in the <code>Authentication</code> or <code>Principal</code>. It slso removes the user from the user cache to force a refresh at next login.<p class='paragraph'></p>Example:<p class='paragraph'></p><div class='code'><pre>class UserController {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def update = {
      def userInstance = User.get(params.id)<p class='paragraph'></p>      params.salt = person.salt
      <span class='java-keyword'>if</span> (userInstance.password != params.password) {
         params.password = springSecurityService.encodePassword(params.password, salt)
         def salt = &#x2026; // e.g. randomly generated using some utility method
         params.salt = salt
      }
      userInstance.properties = params
      <span class='java-keyword'>if</span> (!userInstance.save(flush: <span class='java-keyword'>true</span>)) {
         render view: 'edit', model: [userInstance: userInstance]
         <span class='java-keyword'>return</span>
      }<p class='paragraph'></p><span class='java-keyword'>if</span> (springSecurityService.loggedIn &amp;&amp;
             springSecurityService.principal.username == userInstance.username) {
         springSecurityService.reauthenticate userInstance.username
      }<p class='paragraph'></p>      flash.message = <span class='java-quote'>"The user was updated"</span>
      redirect action: show, id: userInstance.id
   }
}</pre></div><p class='paragraph'></p><h2><a name='4.3. SpringSecurityUtils'>4.3. SpringSecurityUtils</a></h2><code>org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils</code> is a utility class with static methods that can be called directly without using dependency injection. It's primarily an internal class but can be called from application code.<p class='paragraph'></p><h4>authoritiesToRoles()</h4><p class='paragraph'></p>Extracts role names from an array or <code>Collection</code> of <a target='blank' href='http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html'>GrantedAuthority</a>.<p class='paragraph'></p><h4>getPrincipalAuthorities()</h4><p class='paragraph'></p>Retrieves the currently logged-in user's authorities. Will be empty (but never <code>null</code>) if not logged in.<p class='paragraph'></p><h4>parseAuthoritiesString()</h4><p class='paragraph'></p>Splits a comma-delimited String containing role names into a <code>List</code> of <a target='blank' href='http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html'>GrantedAuthority</a><p class='paragraph'></p><h4>ifAllGranted()</h4><p class='paragraph'></p>Checks if the current user has all of the specified roles (a comma-delimited String of role names). This is primarily used by <code>SecurityTagLib.ifAllGranted</code><p class='paragraph'></p><h4>ifNotGranted()</h4><p class='paragraph'></p>Checks if the current user has none of the specified roles (a comma-delimited String of role names). This is primarily used by <code>SecurityTagLib.ifNotGranted</code><p class='paragraph'></p><h4>ifAnyGranted()</h4><p class='paragraph'></p>Checks if the current user has any of the specified roles (a comma-delimited String of role names). This is primarily used by <code>SecurityTagLib.ifAnyGranted</code><p class='paragraph'></p><h4>getSecurityConfig()</h4><p class='paragraph'></p>Retrieves the security part of the <code>Configuration</code> (from <code>grails-app/conf/Config.groovy</code>).<p class='paragraph'></p><h4>loadSecondaryConfig()</h4><p class='paragraph'></p>Used by dependent plugins to add configuration attributes.<p class='paragraph'></p><h4>reloadSecurityConfig()</h4><p class='paragraph'></p>Forces a reload of the security configuration.<p class='paragraph'></p><h4>isAjax()</h4><p class='paragraph'></p>Checks if the request was triggered by an Ajax call. The standard way to determine this is to see if <code>X-Requested-With</code> request header is set and has the value <code>XMLHttpRequest</code>. The plugin relaxes this a bit and only checks if the header is set to any value. In addition, you can configure the name of the header using the <code>grails.plugins.springsecurity.ajaxHeader</code> configuration attribute, but this shouldn't be done in general since all of the major JavaScript toolkits use the standard name.<p class='paragraph'></p>In addition, you can force the request to be treated as Ajax by appending <code>&amp;ajax=true</code> to your request query string.<p class='paragraph'></p><h4>registerProvider()</h4><p class='paragraph'></p>Used by dependent plugins to register an <a target='blank' href='http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AuthenticationProvider.html'>AuthenticationProvider</a> bean name.<p class='paragraph'></p><h4>registerFilter()</h4><p class='paragraph'></p>Used by dependent plugins to register a filter bean name in a specified position in the filter chain.<p class='paragraph'></p><h4>isSwitched()</h4><p class='paragraph'></p>Checks if the current user switched from another user.<p class='paragraph'></p><h4>getSwitchedUserOriginalUsername()</h4><p class='paragraph'></p>Gets the original user's username if the current user switched from another user.<p class='paragraph'></p>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body></html>