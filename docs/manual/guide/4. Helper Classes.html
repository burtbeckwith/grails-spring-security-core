<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>4. Helper Classes</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    <h1><a name="4. Helper Classes">4. Helper Classes</a></h1>The plugin has a few helper classes that you can use in your application to avoid having to deal with the lower-level details of Spring Security.
<h2><a name="4.1. Security Tags">4.1. Security Tags</a></h2>The plugin comes with a few GSP tags to support conditional display based on whether the user is authenticated, and/or has the required role to perform some action. All of the tags are in the <code>sec</code> namespace and are implemented in <code>grails.plugins.springsecurity.SecurityTagLib</code>.<p class="paragraph"/><h4>ifLoggedIn</h4><p class="paragraph"/>Displays the inner body content if the user is authenticated.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Welcome Back!
&#60;/sec:ifLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifNotLoggedIn</h4><p class="paragraph"/>Displays the inner body content if the user is not authenticated.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifNotLoggedIn&#62;
&#60;g:link controller='login' action='auth'&#62;Login&#60;/g:link&#62;
&#60;/sec:ifNotLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifAllGranted</h4><p class="paragraph"/>Displays the inner body content only if all of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifAllGranted roles=<span class="java&#45;quote">"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&#62;secure stuff here&#60;/sec:ifAllGranted&#62;</pre></div><p class="paragraph"/><h4>ifAnyGranted</h4><p class="paragraph"/>Displays the inner body content if at least one of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifAnyGranted roles=<span class="java&#45;quote">"ROLE_ADMIN,ROLE_SUPERVISOR"</span>&#62;secure stuff here&#60;/sec:ifAnyGranted&#62;</pre></div><p class="paragraph"/><h4>ifNotGranted</h4><p class="paragraph"/>Displays the inner body content if none of the listed roles are granted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifNotGranted roles=<span class="java&#45;quote">"ROLE_USER"</span>&#62;non&#45;user stuff here&#60;/sec:ifNotGranted&#62;</pre></div><p class="paragraph"/><h4> loggedInUserInfo</h4><p class="paragraph"/>Displays the value of the specified authentication field if logged in. For example this will show the username property:<p class="paragraph"/><div class="code"><pre>&#60;sec:loggedInUserInfo field=<span class="java&#45;quote">"username"</span>/&#62;</pre></div><p class="paragraph"/>and if you have customized the authentication to add a <code>fullName</code> property, you would access it using<p class="paragraph"/><div class="code"><pre>Welcome Back &#60;sec:loggedInUserInfo field=<span class="java&#45;quote">"fullName"</span>/&#62;</pre></div><p class="paragraph"/><h4> username</h4><p class="paragraph"/>Displays the value of the authentication <code>username</code> field if logged in.<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Welcome Back &#60;sec:username/&#62;!
&#60;/sec:ifLoggedIn&#62;
&#60;sec:ifNotLoggedIn&#62;
&#60;g:link controller='login' action='auth'&#62;Login&#60;/g:link&#62;
&#60;/sec:ifNotLoggedIn&#62;</pre></div><p class="paragraph"/><h4>ifSwitched</h4><p class="paragraph"/>Displays the inner body content only if the current user switched from another user.<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;
Logged in as &#60;sec:username/&#62;
&#60;/sec:ifLoggedIn&#62;<p class="paragraph"/>&#60;sec:ifSwitched&#62;
&#60;a href='$&#123;request.contextPath&#125;/j_spring_security_exit_user'&#62;
   Resume as &#60;sec:switchedUserOriginalUsername/&#62;
&#60;/a&#62;
&#60;/sec:ifSwitched&#62;<p class="paragraph"/>&#60;sec:ifNotSwitched&#62;<p class="paragraph"/>   &#60;sec:ifAllGranted roles='ROLE_SWITCH_USER'&#62;<p class="paragraph"/>   &#60;form action='$&#123;request.contextPath&#125;/j_spring_security_switch_user' method='POST'&#62;<p class="paragraph"/>      Switch to user: &#60;input type='text' name='j_username'/&#62;&#60;br/&#62;<p class="paragraph"/>      &#60;input type='submit' value='Switch'/&#62; &#60;/form&#62;<p class="paragraph"/>   &#60;/sec:ifAllGranted&#62;<p class="paragraph"/>&#60;/sec:ifNotSwitched&#62;</pre></div><p class="paragraph"/><h4>ifNotSwitched</h4><p class="paragraph"/>Displays the inner body content only if the current user has not switched from another user.<p class="paragraph"/><h4>switchedUserOriginalUsername</h4><p class="paragraph"/>Renders the original user's username if the current user switched from another user.<p class="paragraph"/><h2><a name="4.2. SpringSecurityService">4.2. SpringSecurityService</a></h2><code>grails.plugins.springsecurity.SpringSecurityService</code> provides security utility functions. It's a regular Grails service, so you can use dependency injection to inject it into a controller, service, taglib, etc.:<p class="paragraph"/><div class="code"><pre>def springSecurityService</pre></div><p class="paragraph"/><h4>isLoggedIn()</h4><p class="paragraph"/>Checks to see if there's a currently logged-in user.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      <span class="java&#45;keyword">if</span> (springSecurityService.isLoggedIn()) &#123;
         &#8230;
      &#125;
      <span class="java&#45;keyword">else</span> &#123;
         &#8230;
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getAuthentication()</h4><p class="paragraph"/>Retrieves the current user's <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html" target="blank">Authentication</a> if logged in, or <code>null</code> otherwise.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def auth = springSecurityService.authentication
      <span class="java&#45;object">String</span> username = auth.username
      def authorities = auth.authorities // a Collection of GrantedAuthority
      <span class="java&#45;object">boolean</span> authenticated = auth.authenticated
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>getPrincipal()</h4><p class="paragraph"/>Retrieves the currently logged in user's <code>Principal</code>, or <code>null</code> if not logged in. This will be a <code>org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser</code> unless you've created a custom <code>UserDetailsService</code>, in which case it'll be whatever implementation of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/userdetails/UserDetails.html" target="blank">UserDetails</a> you use there.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class SomeController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def someAction = &#123;
      def principal = springSecurityService.principal
      <span class="java&#45;object">String</span> username = principal.username
      def authorities = principal.authorities // a Collection of GrantedAuthority
      <span class="java&#45;object">boolean</span> enabled = principal.enabled
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>encodePassword()</h4><p class="paragraph"/>Encrypts a password using the configured encryption scheme. By default the plugin uses SHA-256, but this is configurable using the <code>grails.plugins.springsecurity.password.algorithm</code> attribute in <code>Config.groovy</code>. You can use any message digest algorithm that's supported in your JDK; see <a href="http://java.sun.com/j2se/1.5.0/docs/guide/security/CryptoSpec.html#AppA" target="blank">this page</a> for information on what's available. In particular you are <strong class="bold">strongly</strong> discouraged from using MD5 or SHA-1 algorithms since they are rather weak and have well-known vulnerabilities. You should also use a salt for your passwords, which greatly increases the computational complexity of decrypting passwords if your database gets compromised. See <a href="../guide/single.html#10.5. Salted passwords" class="guide">here</a> for details on using salted passwords.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class PersonController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def updateAction = &#123;
      def person = Person.get(params.id)<p class="paragraph"/>      params.salt = person.salt
      <span class="java&#45;keyword">if</span> (person.password != params.password) &#123;
         params.password = springSecurityService.encodePassword(password, salt)
         def salt = &#8230; // e.g. randomly generated using some utility method
         params.salt = salt
      &#125;
      person.properties = params
      <span class="java&#45;keyword">if</span> (!person.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;person: person&#93;
         <span class="java&#45;keyword">return</span>
      &#125;
      redirect action: show, id: person.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>updateRole()</h4><p class="paragraph"/>Updates a role and if you're using <code>Requestmap</code> instances to manage securing URLs, will replace the new role name in all <code>Requestmap</code> definitions that use it if the name was changed.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RoleController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def update = &#123;
      def roleInstance = Role.get(params.id)
      <span class="java&#45;keyword">if</span> (!springSecurityService.updateRole(roleInstance, params)) &#123;
         render view: 'edit', model: &#91;roleInstance: roleInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The role was updated"</span>
      redirect action: show, id: roleInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>deleteRole()</h4><p class="paragraph"/>Deletes a role and if you're using <code>Requestmap</code> instances to manage securing URLs, will remove the role from all <code>Requestmap</code> definitions. If a <code>Requestmap</code>'s config attribute is just this role's name (e.g. "/foo/bar/<strong class="bold"></strong>=ROLE_FOO") it will be deleted.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RoleController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def delete = &#123;
      def roleInstance = Role.get(params.id)
      <span class="java&#45;keyword">try</span> &#123;
         springSecurityService.deleteRole (roleInstance
         flash.message = <span class="java&#45;quote">"The role was deleted"</span>
         redirect action: list
      &#125;
      <span class="java&#45;keyword">catch</span> (DataIntegrityViolationException e) &#123;
         flash.message = <span class="java&#45;quote">"Unable to delete the role"</span>
         redirect action: show, id: params.id
      &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>clearCachedRequestmaps()</h4><p class="paragraph"/>If you're using <code>Requestmap</code> instances to manage securing URLs, the plugin will load and cache all <code>Requestmap</code> instances as a performance optimization. This saves a lot of database activity since the requestmaps are checked for each request. But you can't allow the cache to become stale, so when you create, edit or delete a <code>Requestmap</code> you should flush the cache to trigger a complete reload. Both <code>updateRole()</code> and <code>deleteRole()</code> call this method for you, so you should call this when you create a new <code>Requestmap</code> or if you do some other <code>Requestmap</code> work that would affect the cache.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class RequestmapController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def save = &#123;
      def requestmapInstance = <span class="java&#45;keyword">new</span> Requestmap(params)
      <span class="java&#45;keyword">if</span> (!requestmapInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'create', model: &#91;requestmapInstance: requestmapInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      springSecurityService.clearCachedRequestmaps()
      flash.message = <span class="java&#45;quote">"Requestmap created"</span>
      redirect action: show, id: requestmapInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>reauthenticate()</h4><p class="paragraph"/>Rebuilds an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/Authentication.html" target="blank">Authentication</a> for the given username and registers it in the security context. This is typically used after updating a user's authorities or other data that is cached in the <code>Authentication</code> or <code>Principal</code>. It slso removes the user from the user cache to force a refresh at next login.<p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>class UserController &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def update = &#123;
      def userInstance = User.get(params.id)<p class="paragraph"/>      params.salt = person.salt
      <span class="java&#45;keyword">if</span> (userInstance.password != params.password) &#123;
         params.password = springSecurityService.encodePassword(params.password, salt)
         def salt = &#8230; // e.g. randomly generated using some utility method
         params.salt = salt
      &#125;
      userInstance.properties = params
      <span class="java&#45;keyword">if</span> (!userInstance.save(flush: <span class="java&#45;keyword">true</span>)) &#123;
         render view: 'edit', model: &#91;userInstance: userInstance&#93;
         <span class="java&#45;keyword">return</span>
      &#125;<p class="paragraph"/>      <span class="java&#45;keyword">if</span> (springSecurityService.loggedIn &#38;&#38;
             springSecurityService.principal.username == userInstance.username) &#123;
         springSecurityService.reauthenticate userInstance.username
      &#125;<p class="paragraph"/>      flash.message = <span class="java&#45;quote">"The user was updated"</span>
      redirect action: show, id: userInstance.id
   &#125;
&#125;</pre></div><p class="paragraph"/><h2><a name="4.3. SpringSecurityUtils">4.3. SpringSecurityUtils</a></h2><code>org.codehaus.groovy.grails.plugins.springsecurity.SpringSecurityUtils</code> is a utility class with static methods that can be called directly without using dependency injection. It's primarily an internal class but can be called from application code.<p class="paragraph"/><h4>authoritiesToRoles()</h4><p class="paragraph"/>Extracts role names from an array or <code>Collection</code> of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html" target="blank">GrantedAuthority</a>.<p class="paragraph"/><h4>getPrincipalAuthorities()</h4><p class="paragraph"/>Retrieves the currently logged-in user's authorities. Will be empty (but never <code>null</code>) if not logged in.<p class="paragraph"/><h4>parseAuthoritiesString()</h4><p class="paragraph"/>Splits a comma-delimited String containing role names into a <code>List</code> of <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/core/GrantedAuthority.html" target="blank">GrantedAuthority</a><p class="paragraph"/><h4>ifAllGranted()</h4><p class="paragraph"/>Checks if the current user has all of the specified roles (a comma-delimited String of role names). This is primarily used by <code>SecurityTagLib.ifAllGranted</code><p class="paragraph"/><h4>ifNotGranted()</h4><p class="paragraph"/>Checks if the current user has none of the specified roles (a comma-delimited String of role names). This is primarily used by <code>SecurityTagLib.ifNotGranted</code><p class="paragraph"/><h4>ifAnyGranted()</h4><p class="paragraph"/>Checks if the current user has any of the specified roles (a comma-delimited String of role names). This is primarily used by <code>SecurityTagLib.ifAnyGranted</code><p class="paragraph"/><h4>getSecurityConfig()</h4><p class="paragraph"/>Retrieves the security part of the <code>Configuration</code> (from <code>grails-app/conf/Config.groovy</code>).<p class="paragraph"/><h4>loadSecondaryConfig()</h4><p class="paragraph"/>Used by dependent plugins to add configuration attributes.<p class="paragraph"/><h4>reloadSecurityConfig()</h4><p class="paragraph"/>Forces a reload of the security configuration.<p class="paragraph"/><h4>isAjax()</h4><p class="paragraph"/>Checks if the request was triggered by an Ajax call. The standard way to determine this is to see if <code>X-Requested-With</code> request header is set and has the value <code>XMLHttpRequest</code>. The plugin relaxes this a bit and only checks if the header is set to any value. In addition, you can configure the name of the header using the <code>grails.plugins.springsecurity.ajaxHeader</code> configuration attribute, but this shouldn't be done in general since all of the major JavaScript toolkits use the standard name.<p class="paragraph"/>In addition, you can force the request to be treated as Ajax by appending <code>&#38;ajax=true</code> to your request query string.<p class="paragraph"/><h4>registerProvider()</h4><p class="paragraph"/>Used by dependent plugins to register an <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/apidocs/org/springframework/security/authentication/AuthenticationProvider.html" target="blank">AuthenticationProvider</a> bean name.<p class="paragraph"/><h4>registerFilter()</h4><p class="paragraph"/>Used by dependent plugins to register a filter bean name in a specified position in the filter chain.<p class="paragraph"/><h4>isSwitched()</h4><p class="paragraph"/>Checks if the current user switched from another user.<p class="paragraph"/><h4>getSwitchedUserOriginalUsername()</h4><p class="paragraph"/>Gets the original user's username if the current user switched from another user.<p class="paragraph"/>
    
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker('UA-16219500-1');
pageTracker._trackPageview();
} catch(err) {}
</script>
</body>
</html>
